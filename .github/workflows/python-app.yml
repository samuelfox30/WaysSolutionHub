name: Deploy Flask App

on:
  push:
    branches: [ master ]

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
    # 1. Baixa o cÃ³digo
    - name: ðŸšš Get latest code
      uses: actions/checkout@v4

    # 2. Envia os arquivos (Passo que vocÃª jÃ¡ tinha)
    - name: ðŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.SFTP_SERVER }}
        username: ${{ secrets.SFTP_USERNAME }}
        password: ${{ secrets.SFTP_PASSWORD }}
        protocol: sftp
        port: 22 
        server-dir: /home/ubuntu/meu-projeto-flask/ # CONFIRA ESSE CAMINHO
        exclude: |
          **/.git*
          **/.git*/**
          **/venv/**
          **/__pycache__/**
          .github/**

    # 3. O PULO DO GATO: Rodar comandos no servidor
    - name: ðŸš€ Restart Flask Service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SFTP_SERVER }}
        username: ${{ secrets.SFTP_USERNAME }}
        password: ${{ secrets.SFTP_PASSWORD }}
        port: 22
        # Aqui estÃ£o os comandos que seriam digitados no terminal
        script: |
          cd /home/ubuntu/meu-projeto-flask/
          
          # 1. Ativar venv e instalar libs novas
          source venv/bin/activate
          pip install -r requirements.txt
          
          # 2. Reiniciar o serviÃ§o (Supondo que vocÃª usa Systemd/Gunicorn)
          # VocÃª precisa ter permissÃ£o de sudo ou configurar para nÃ£o pedir senha
          sudo systemctl restart meuflaskapp
