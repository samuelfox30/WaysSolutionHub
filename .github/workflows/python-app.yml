name: Deploy Flask App

on:
  push:
    branches: [ master ]

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
    # 1. Baixa o cÃ³digo do GitHub
    - name: ðŸšš Get latest code
      uses: actions/checkout@v4

    # 2. Envia os arquivos via SFTP (Usando SCP Action)
    - name: ðŸ“‚ Sync files via SFTP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SFTP_SERVER }}
        username: ${{ secrets.SFTP_USERNAME }}
        password: ${{ secrets.SFTP_PASSWORD }}
        port: 22
        source: "."
        target: "/home/ubuntu/meu-projeto-flask/"
        # Removemos .git e venv para nÃ£o deixar o upload lento
        rm: false
        strip_components: 0
        exclude: ".git,.github,.gitignore,venv,__pycache__"

    # 3. Conecta via SSH para instalar libs e reiniciar
    - name: ðŸš€ Install Req & Restart
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SFTP_SERVER }}
        username: ${{ secrets.SFTP_USERNAME }}
        password: ${{ secrets.SFTP_PASSWORD }}
        port: 22
        script: |
          # Entra na pasta
          cd /home/ubuntu/meu-projeto-flask/
          
          # Ativa venv e atualiza dependÃªncias
          # (Se seu venv tiver outro nome, ajuste aqui)
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Reinicia o serviÃ§o do Flask
          # ATENÃ‡ÃƒO: Troque 'meuflaskapp' pelo nome do seu serviÃ§o real
          sudo systemctl restart meuflaskapp
