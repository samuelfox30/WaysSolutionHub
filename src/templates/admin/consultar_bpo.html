{% extends "admin/base.html" %}

{% block header_title %}Consultar Dados BPO - Tabela Completa{% endblock %}
{% block header_subtitle %}Visualize os dados mensais de BPO em formato de planilha{% endblock %}

{% block content %}

<style>
    .filter-card {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
    }

    .filter-card h5 {
        font-weight: 700;
        margin-bottom: 20px;
        font-size: 1.3rem;
    }

    .filter-card .form-label {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .filter-card .form-select,
    .filter-card .form-control {
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 10px 15px;
        font-weight: 500;
    }

    .btn-consultar {
        background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
        border: none;
        color: white;
        padding: 12px 40px;
        font-weight: 700;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        transition: all 0.3s ease;
    }

    .btn-consultar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 107, 53, 0.6);
        background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
    }

    /* Tabela tipo Excel */
    .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .table-scroll {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 70vh;
    }

    .excel-table {
        width: auto;
        min-width: 100%;
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.85rem;
    }

    .excel-table thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        font-weight: 700;
        text-align: center;
        padding: 15px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        white-space: nowrap;
        z-index: 10;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .excel-table thead th:first-child {
        position: sticky;
        left: 0;
        z-index: 11;
        min-width: 300px;
        text-align: left;
    }

    .excel-table tbody tr {
        transition: all 0.2s ease;
    }

    .excel-table tbody tr:hover {
        background-color: #fff4e6;
        box-shadow: 0 2px 8px rgba(255, 107, 53, 0.1);
    }

    .excel-table tbody td {
        padding: 12px;
        border: 1px solid #e9ecef;
        white-space: nowrap;
        text-align: right;
        font-weight: 500;
    }

    .excel-table tbody td:first-child {
        position: sticky;
        left: 0;
        background: white;
        font-weight: 600;
        text-align: left;
        z-index: 9;
        border-right: 2px solid #dee2e6;
        white-space: normal;
        word-wrap: break-word;
        min-width: 300px;
        max-width: 300px;
    }

    .excel-table tbody tr:hover td:first-child {
        background-color: #fff4e6;
    }

    /* Indenta√ß√£o de hierarquia */
    .nivel-1 { padding-left: 10px !important; font-weight: 700; }
    .nivel-2 { padding-left: 30px !important; font-weight: 600; }
    .nivel-3 { padding-left: 50px !important; }
    .nivel-4 { padding-left: 70px !important; }
    .nivel-5 { padding-left: 90px !important; }

    /* Colunas de totais */
    .col-total {
        background-color: #fff4e6;
        font-weight: 700;
        border-left: 3px solid #ff8c42 !important;
    }

    /* Valores condicionais */
    .valor-positivo {
        color: #10b981;
        font-weight: 600;
    }

    .valor-negativo {
        color: #ef4444;
        font-weight: 600;
    }

    .valor-neutro {
        color: #6b7280;
        font-weight: 500;
    }

    /* Tabelas de cen√°rios */
    .cenarios-section {
        margin-top: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #fef3e7 0%, #ffe5cc 100%);
        border-radius: 15px;
    }

    .cenario-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(255, 107, 53, 0.1);
        border: 1px solid rgba(255, 140, 66, 0.2);
    }

    .cenario-card h6 {
        font-weight: 700;
        margin-bottom: 15px;
        color: #ff6b35;
        font-size: 1.1rem;
    }

    .cenario-table {
        width: 100%;
        font-size: 0.9rem;
    }

    .cenario-table thead th {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        font-weight: 600;
        padding: 12px;
        text-align: center;
    }

    .cenario-table tbody td {
        padding: 10px 12px;
        text-align: right;
        font-weight: 500;
    }

    .cenario-table tbody td:first-child {
        text-align: left;
        font-weight: 600;
        color: #ff6b35;
    }

    /* Loading spinner */
    .loading {
        text-align: center;
        padding: 50px;
        font-size: 1.2rem;
        color: #ff6b35;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }
</style>

<div class="container-fluid px-4">

    <!-- CARD DE FILTROS -->
    <div class="filter-card">
        <h5><i class="bi bi-funnel-fill me-2"></i>Filtro de Per√≠odo</h5>

        <div class="row g-3">
            <!-- Selecionar Empresa -->
            <div class="col-md-6">
                <label for="empresa_id" class="form-label">
                    <i class="bi bi-building me-1"></i>Empresa *
                </label>
                <select class="form-select" id="empresa_id" required>
                    <option value="">Selecione uma empresa...</option>
                    {% for empresa in empresas %}
                    <option value="{{ empresa.id }}">
                        {{ empresa.nome }} ({{ empresa.cnpj }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Per√≠odo -->
            <div class="col-md-6">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar-check me-1"></i>M√™s In√≠cio</label>
                        <select class="form-select" id="mes_inicio">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Mar√ßo</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12" selected>Dezembro</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar4 me-1"></i>Ano In√≠cio</label>
                        <input type="number" class="form-control" id="ano_inicio" min="2000" max="2100" value="2025">
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar-x me-1"></i>M√™s Fim</label>
                        <select class="form-select" id="mes_fim">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Mar√ßo</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12" selected>Dezembro</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar4 me-1"></i>Ano Fim</label>
                        <input type="number" class="form-control" id="ano_fim" min="2000" max="2100" value="2025">
                    </div>
                </div>
            </div>

            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-consultar w-100" onclick="carregarDados()">
                    <i class="bi bi-search me-2"></i>Consultar Dados BPO
                </button>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Carregando dados...</p>
    </div>

    <!-- TABELA PRINCIPAL -->
    <div id="table-container" class="table-container" style="display: none;">
        <div class="table-scroll">
            <table class="excel-table" id="excel-table">
                <thead id="table-header">
                    <!-- Cabe√ßalho ser√° gerado dinamicamente -->
                </thead>
                <tbody id="table-body">
                    <!-- Corpo ser√° gerado dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- CEN√ÅRIOS -->
    <div id="cenarios-section" class="cenarios-section" style="display: none;">
        <h4 class="text-center mb-4" style="font-weight: 700; color: #ff6b35;">
            <i class="bi bi-calculator-fill me-2"></i>Totais Calculados por Cen√°rio
        </h4>

        <!-- Fluxo de Caixa -->
        <div class="cenario-card">
            <h6><i class="bi bi-cash-stack me-2"></i>Resultado por Fluxo de Caixa</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead>
                        <tr id="fc-header-row">
                            <th>Categoria</th>
                            <!-- Colunas dos meses ser√£o adicionadas dinamicamente -->
                        </tr>
                    </thead>
                    <tbody id="fc-body">
                        <!-- Ser√° preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resultado Real -->
        <div class="cenario-card">
            <h6><i class="bi bi-graph-up-arrow me-2"></i>Resultado Real</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead>
                        <tr id="real-header-row">
                            <th>Categoria</th>
                            <!-- Colunas dos meses ser√£o adicionadas dinamicamente -->
                        </tr>
                    </thead>
                    <tbody id="real-body">
                        <!-- Ser√° preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resultado Real + MP -->
        <div class="cenario-card">
            <h6><i class="bi bi-pie-chart-fill me-2"></i>Resultado Real + Custo Mat√©ria Prima</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead>
                        <tr id="realmp-header-row">
                            <th>Categoria</th>
                            <!-- Colunas dos meses ser√£o adicionadas dinamicamente -->
                        </tr>
                    </thead>
                    <tbody id="realmp-body">
                        <!-- Ser√° preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
function formatMoney(value) {
    if (value === null || value === undefined) return '-';
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

function formatMoneyCondicional(value) {
    if (value === null || value === undefined) return '<span class="valor-neutro">-</span>';

    const formatted = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);

    if (value > 0) {
        return `<span class="valor-positivo"><i class="bi bi-arrow-up-circle-fill me-1"></i>${formatted}</span>`;
    } else if (value < 0) {
        return `<span class="valor-negativo"><i class="bi bi-arrow-down-circle-fill me-1"></i>${formatted}</span>`;
    } else {
        return `<span class="valor-neutro">${formatted}</span>`;
    }
}

function formatPercent(value) {
    if (value === null || value === undefined) return '-';
    return value.toFixed(2) + '%';
}

function formatPercentCondicional(value) {
    if (value === null || value === undefined) return '<span class="valor-neutro">-</span>';

    const formatted = value.toFixed(2) + '%';

    if (value >= 100) {
        return `<span class="valor-positivo"><i class="bi bi-check-circle-fill me-1"></i>${formatted}</span>`;
    } else if (value >= 80) {
        return `<span style="color: #f59e0b; font-weight: 600;"><i class="bi bi-exclamation-circle-fill me-1"></i>${formatted}</span>`;
    } else {
        return `<span class="valor-negativo"><i class="bi bi-x-circle-fill me-1"></i>${formatted}</span>`;
    }
}

async function carregarDados() {
    const empresaId = document.getElementById('empresa_id').value;
    const mesInicio = document.getElementById('mes_inicio').value;
    const anoInicio = document.getElementById('ano_inicio').value;
    const mesFim = document.getElementById('mes_fim').value;
    const anoFim = document.getElementById('ano_fim').value;

    if (!empresaId) {
        alert('Selecione uma empresa');
        return;
    }

    // Mostrar loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('table-container').style.display = 'none';
    document.getElementById('cenarios-section').style.display = 'none';

    try {
        {% if is_user_view %}
        const url = `/user/api/dados-bpo-tabela/${empresaId}?mes_inicio=${mesInicio}&ano_inicio=${anoInicio}&mes_fim=${mesFim}&ano_fim=${anoFim}`;
        {% else %}
        const url = `/admin/api/dados-bpo-tabela/${empresaId}?mes_inicio=${mesInicio}&ano_inicio=${anoInicio}&mes_fim=${mesFim}&ano_fim=${anoFim}`;
        {% endif %}

        const response = await fetch(url);
        const data = await response.json();

        if (data.error) {
            alert('Erro: ' + data.error);
            document.getElementById('loading').style.display = 'none';
            return;
        }

        // Renderizar tabela
        renderizarTabela(data);

        // Renderizar cen√°rios
        renderizarCenarios(data);

        // Mostrar tabelas
        document.getElementById('loading').style.display = 'none';
        document.getElementById('table-container').style.display = 'block';
        document.getElementById('cenarios-section').style.display = 'block';

    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar dados: ' + error.message);
        document.getElementById('loading').style.display = 'none';
    }
}

function renderizarTabela(data) {
    const { itens, meses } = data;

    // Encontrar o item RECEITA e mapear valores or√ßados por m√™s
    const receitaPorMes = {};
    const itemReceita = itens.find(item =>
        item.codigo === "1" ||
        item.nome.toUpperCase().includes("RECEITA") && item.codigo.startsWith("1")
    );

    if (itemReceita) {
        meses.forEach(mes => {
            const chave = `${mes.ano}_${mes.mes_numero}`;
            const dados = itemReceita.dados_mensais[chave];
            if (dados && dados.valor_orcado) {
                receitaPorMes[chave] = dados.valor_orcado;
            }
        });
    }

    console.log('üìä Item RECEITA encontrado:', itemReceita);
    console.log('üí∞ Receita por m√™s:', receitaPorMes);

    // Gerar cabe√ßalho
    let headerHTML = '<tr><th>Descri√ß√£o</th>';

    // Colunas dos meses (5 colunas por m√™s agora)
    meses.forEach(mes => {
        headerHTML += `
            <th colspan="5" style="border-bottom: 3px solid white;">${mes.mes_nome} ${mes.ano}</th>
        `;
    });

    // Colunas de totais
    headerHTML += `<th colspan="3" style="background: #ffd54f; color: #333; border-left: 3px solid #333;">Totais do Per√≠odo</th>`;
    headerHTML += '</tr>';

    // Segunda linha do cabe√ßalho com subcolunas
    headerHTML += '<tr><th></th>';
    meses.forEach(() => {
        headerHTML += `
            <th>Or√ßado</th>
            <th>% Or√ßado</th>
            <th>Realizado</th>
            <th>% Atingido</th>
            <th>Diferen√ßa</th>
        `;
    });
    headerHTML += `
        <th class="col-total">Total Or√ßado</th>
        <th class="col-total">Total Realizado</th>
        <th class="col-total">Diferen√ßa</th>
    `;
    headerHTML += '</tr>';

    document.getElementById('table-header').innerHTML = headerHTML;

    // Gerar corpo da tabela
    let bodyHTML = '';

    itens.forEach(item => {
        bodyHTML += `<tr>`;

        // Coluna de descri√ß√£o com hierarquia
        bodyHTML += `<td class="nivel-${item.nivel_hierarquia}">`;
        if (item.codigo) {
            bodyHTML += `<code>${item.codigo}</code> `;
        }
        bodyHTML += `${item.nome}</td>`;

        // Calcular totais
        let totalOrcado = 0;
        let totalRealizado = 0;

        // Dados mensais
        meses.forEach(mes => {
            const chave = `${mes.ano}_${mes.mes_numero}`;
            const dados = item.dados_mensais[chave];

            if (dados) {
                const orcado = dados.valor_orcado || 0;
                const realizado = dados.valor_realizado || 0;
                const perc = dados.perc_atingido || 0;
                const dif = dados.valor_diferenca || 0;

                totalOrcado += orcado;
                totalRealizado += realizado;

                // Calcular % Or√ßado (percentual sobre a RECEITA do m√™s)
                const receitaMes = receitaPorMes[chave] || 0;
                let percOrcado = 0;
                if (receitaMes > 0) {
                    percOrcado = (orcado / receitaMes) * 100;
                }

                bodyHTML += `
                    <td>${formatMoney(orcado)}</td>
                    <td style="color: #6b7280; font-weight: 500;">${formatPercent(percOrcado)}</td>
                    <td>${formatMoney(realizado)}</td>
                    <td>${formatPercentCondicional(perc)}</td>
                    <td>${formatMoneyCondicional(dif)}</td>
                `;
            } else {
                bodyHTML += `<td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>`;
            }
        });

        // Totais
        const totalDif = totalOrcado - totalRealizado;
        bodyHTML += `
            <td class="col-total">${formatMoney(totalOrcado)}</td>
            <td class="col-total">${formatMoney(totalRealizado)}</td>
            <td class="col-total">${formatMoneyCondicional(totalDif)}</td>
        `;

        bodyHTML += `</tr>`;
    });

    document.getElementById('table-body').innerHTML = bodyHTML;
}

function renderizarCenarios(data) {
    const { totais_calculados, meses } = data;

    console.log('üîç DEBUG renderizarCenarios:');
    console.log('   totais_calculados:', totais_calculados);
    console.log('   meses:', meses);
    console.log('   fluxo_caixa keys:', Object.keys(totais_calculados.fluxo_caixa || {}));
    console.log('   real keys:', Object.keys(totais_calculados.real || {}));
    console.log('   real_mp keys:', Object.keys(totais_calculados.real_mp || {}));

    // Cabe√ßalho dos cen√°rios (colunas para cada m√™s)
    let headerCols = '';
    meses.forEach(mes => {
        headerCols += `<th>${mes.mes_nome} ${mes.ano}</th>`;
    });

    // Adicionar colunas de meses ao cabe√ßalho (ap√≥s a coluna "Categoria")
    const fcHeaderRow = document.getElementById('fc-header-row');
    const realHeaderRow = document.getElementById('real-header-row');
    const realmpHeaderRow = document.getElementById('realmp-header-row');

    // Limpar colunas antigas (mant√©m apenas primeira coluna "Categoria")
    fcHeaderRow.innerHTML = '<th>Categoria</th>' + headerCols;
    realHeaderRow.innerHTML = '<th>Categoria</th>' + headerCols;
    realmpHeaderRow.innerHTML = '<th>Categoria</th>' + headerCols;

    // Renderizar cada cen√°rio
    renderizarCenario('fluxo_caixa', 'fc-body', totais_calculados, meses);
    renderizarCenario('real', 'real-body', totais_calculados, meses);
    renderizarCenario('real_mp', 'realmp-body', totais_calculados, meses);
}

function renderizarCenario(tipo, bodyId, totais_calculados, meses) {
    const cenario = totais_calculados[tipo] || {};

    console.log(`üîç DEBUG renderizarCenario(${tipo}):`)
    console.log('   cenario:', cenario);
    console.log('   cenario keys:', Object.keys(cenario));

    const categorias = ['Receita', 'Despesa', 'Geral'];
    const campos = ['orcamento', 'realizado', 'perc_atingido', 'diferenca'];
    const labels = {
        'orcamento': 'Or√ßamento',
        'realizado': 'Realizado',
        'perc_atingido': '% Atingido',
        'diferenca': 'Diferen√ßa'
    };

    let bodyHTML = '';

    campos.forEach(campo => {
        // Linha de t√≠tulo
        bodyHTML += `<tr style="background: #f8f9fa;"><td colspan="${meses.length + 1}"><strong>${labels[campo]}</strong></td></tr>`;

        categorias.forEach(cat => {
            const catKey = cat.toLowerCase();
            bodyHTML += `<tr><td>${cat}</td>`;

            meses.forEach((mes, idx) => {
                const chave = `${mes.ano}_${mes.mes_numero}`;
                const dados = cenario[chave];

                // Log s√≥ do primeiro m√™s de cada campo para n√£o poluir
                if (idx === 0 && cat === 'Receita') {
                    console.log(`      Primeiro m√™s (${mes.mes_nome}): chave=${chave}, dados=`, dados);
                    if (dados) {
                        console.log(`        dados[${campo}]:`, dados[campo]);
                    }
                }

                if (dados && dados[campo] && dados[campo][catKey] !== undefined) {
                    const valor = dados[campo][catKey];
                    if (campo === 'perc_atingido') {
                        bodyHTML += `<td>${formatPercentCondicional(valor)}</td>`;
                    } else if (campo === 'diferenca') {
                        bodyHTML += `<td>${formatMoneyCondicional(valor)}</td>`;
                    } else {
                        bodyHTML += `<td>${formatMoney(valor)}</td>`;
                    }
                } else {
                    bodyHTML += `<td><span class="valor-neutro">-</span></td>`;
                }
            });

            bodyHTML += `</tr>`;
        });
    });

    document.getElementById(bodyId).innerHTML = bodyHTML;
}
</script>

{% endblock %}
