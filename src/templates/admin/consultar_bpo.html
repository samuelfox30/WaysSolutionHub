{% extends "admin/base.html" %}

{% block header_title %}Consultar Dados BPO - Tabela Completa{% endblock %}
{% block header_subtitle %}Visualize os dados mensais de BPO em formato de planilha{% endblock %}

{% block content %}

<style>
    .filter-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .filter-card h5 {
        font-weight: 700;
        margin-bottom: 20px;
        font-size: 1.3rem;
    }

    .filter-card .form-label {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .filter-card .form-select,
    .filter-card .form-control {
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 10px 15px;
        font-weight: 500;
    }

    .btn-consultar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        color: white;
        padding: 12px 40px;
        font-weight: 700;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        transition: all 0.3s ease;
    }

    .btn-consultar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(245, 87, 108, 0.6);
    }

    /* Tabela tipo Excel */
    .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .table-scroll {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 70vh;
    }

    .excel-table {
        width: auto;
        min-width: 100%;
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.85rem;
    }

    .excel-table thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 700;
        text-align: center;
        padding: 15px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        white-space: nowrap;
        z-index: 10;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .excel-table thead th:first-child {
        position: sticky;
        left: 0;
        z-index: 11;
        min-width: 300px;
        text-align: left;
    }

    .excel-table tbody tr {
        transition: all 0.2s ease;
    }

    .excel-table tbody tr:hover {
        background-color: #f8f9ff;
    }

    .excel-table tbody td {
        padding: 12px;
        border: 1px solid #e9ecef;
        white-space: nowrap;
        text-align: right;
        font-weight: 500;
    }

    .excel-table tbody td:first-child {
        position: sticky;
        left: 0;
        background: white;
        font-weight: 600;
        text-align: left;
        z-index: 9;
        border-right: 2px solid #dee2e6;
        white-space: normal;
        word-wrap: break-word;
        min-width: 300px;
        max-width: 300px;
    }

    .excel-table tbody tr:hover td:first-child {
        background-color: #f8f9ff;
    }

    /* Indentação de hierarquia */
    .nivel-1 { padding-left: 10px !important; font-weight: 700; }
    .nivel-2 { padding-left: 30px !important; font-weight: 600; }
    .nivel-3 { padding-left: 50px !important; }
    .nivel-4 { padding-left: 70px !important; }
    .nivel-5 { padding-left: 90px !important; }

    /* Colunas de totais */
    .col-total {
        background-color: #fff8e1;
        font-weight: 700;
        border-left: 3px solid #ffd54f !important;
    }

    /* Tabelas de cenários */
    .cenarios-section {
        margin-top: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 15px;
    }

    .cenario-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .cenario-card h6 {
        font-weight: 700;
        margin-bottom: 15px;
        color: #667eea;
        font-size: 1.1rem;
    }

    .cenario-table {
        width: 100%;
        font-size: 0.9rem;
    }

    .cenario-table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 12px;
        text-align: center;
    }

    .cenario-table tbody td {
        padding: 10px 12px;
        text-align: right;
        font-weight: 500;
    }

    .cenario-table tbody td:first-child {
        text-align: left;
        font-weight: 600;
    }

    /* Loading spinner */
    .loading {
        text-align: center;
        padding: 50px;
        font-size: 1.2rem;
        color: #667eea;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }
</style>

<div class="container-fluid px-4">

    <!-- CARD DE FILTROS -->
    <div class="filter-card">
        <h5><i class="bi bi-funnel-fill me-2"></i>Filtro de Período</h5>

        <div class="row g-3">
            <!-- Selecionar Empresa -->
            <div class="col-md-6">
                <label for="empresa_id" class="form-label">
                    <i class="bi bi-building me-1"></i>Empresa *
                </label>
                <select class="form-select" id="empresa_id" required>
                    <option value="">Selecione uma empresa...</option>
                    {% for empresa in empresas %}
                    <option value="{{ empresa.id }}">
                        {{ empresa.nome }} ({{ empresa.cnpj }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Período -->
            <div class="col-md-6">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar-check me-1"></i>Mês Início</label>
                        <select class="form-select" id="mes_inicio">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Março</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12" selected>Dezembro</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar4 me-1"></i>Ano Início</label>
                        <input type="number" class="form-control" id="ano_inicio" min="2000" max="2100" value="2025">
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar-x me-1"></i>Mês Fim</label>
                        <select class="form-select" id="mes_fim">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Março</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12" selected>Dezembro</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar4 me-1"></i>Ano Fim</label>
                        <input type="number" class="form-control" id="ano_fim" min="2000" max="2100" value="2025">
                    </div>
                </div>
            </div>

            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-consultar w-100" onclick="carregarDados()">
                    <i class="bi bi-search me-2"></i>Consultar Dados BPO
                </button>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Carregando dados...</p>
    </div>

    <!-- TABELA PRINCIPAL -->
    <div id="table-container" class="table-container" style="display: none;">
        <div class="table-scroll">
            <table class="excel-table" id="excel-table">
                <thead id="table-header">
                    <!-- Cabeçalho será gerado dinamicamente -->
                </thead>
                <tbody id="table-body">
                    <!-- Corpo será gerado dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- CENÁRIOS -->
    <div id="cenarios-section" class="cenarios-section" style="display: none;">
        <h4 class="text-center mb-4" style="font-weight: 700; color: #667eea;">
            <i class="bi bi-calculator me-2"></i>Totais Calculados por Cenário
        </h4>

        <!-- Fluxo de Caixa -->
        <div class="cenario-card">
            <h6><i class="bi bi-1-circle-fill me-2"></i>Resultado por Fluxo de Caixa</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th id="fc-header"></th>
                        </tr>
                    </thead>
                    <tbody id="fc-body">
                        <!-- Será preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resultado Real -->
        <div class="cenario-card">
            <h6><i class="bi bi-2-circle-fill me-2"></i>Resultado Real</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th id="real-header"></th>
                        </tr>
                    </thead>
                    <tbody id="real-body">
                        <!-- Será preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resultado Real + MP -->
        <div class="cenario-card">
            <h6><i class="bi bi-3-circle-fill me-2"></i>Resultado Real + Custo Matéria Prima</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th id="realmp-header"></th>
                        </tr>
                    </thead>
                    <tbody id="realmp-body">
                        <!-- Será preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
function formatMoney(value) {
    if (value === null || value === undefined) return '-';
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

function formatPercent(value) {
    if (value === null || value === undefined) return '-';
    return value.toFixed(2) + '%';
}

async function carregarDados() {
    const empresaId = document.getElementById('empresa_id').value;
    const mesInicio = document.getElementById('mes_inicio').value;
    const anoInicio = document.getElementById('ano_inicio').value;
    const mesFim = document.getElementById('mes_fim').value;
    const anoFim = document.getElementById('ano_fim').value;

    if (!empresaId) {
        alert('Selecione uma empresa');
        return;
    }

    // Mostrar loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('table-container').style.display = 'none';
    document.getElementById('cenarios-section').style.display = 'none';

    try {
        {% if is_user_view %}
        const url = `/user/api/dados-bpo-tabela/${empresaId}?mes_inicio=${mesInicio}&ano_inicio=${anoInicio}&mes_fim=${mesFim}&ano_fim=${anoFim}`;
        {% else %}
        const url = `/admin/api/dados-bpo-tabela/${empresaId}?mes_inicio=${mesInicio}&ano_inicio=${anoInicio}&mes_fim=${mesFim}&ano_fim=${anoFim}`;
        {% endif %}

        const response = await fetch(url);
        const data = await response.json();

        if (data.error) {
            alert('Erro: ' + data.error);
            document.getElementById('loading').style.display = 'none';
            return;
        }

        // Renderizar tabela
        renderizarTabela(data);

        // Renderizar cenários
        renderizarCenarios(data);

        // Mostrar tabelas
        document.getElementById('loading').style.display = 'none';
        document.getElementById('table-container').style.display = 'block';
        document.getElementById('cenarios-section').style.display = 'block';

    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar dados: ' + error.message);
        document.getElementById('loading').style.display = 'none';
    }
}

function renderizarTabela(data) {
    const { itens, meses } = data;

    // Gerar cabeçalho
    let headerHTML = '<tr><th>Descrição</th>';

    // Colunas dos meses (4 colunas por mês)
    meses.forEach(mes => {
        headerHTML += `
            <th colspan="4" style="border-bottom: 3px solid white;">${mes.mes_nome} ${mes.ano}</th>
        `;
    });

    // Colunas de totais
    headerHTML += `<th colspan="3" style="background: #ffd54f; color: #333; border-left: 3px solid #333;">Totais do Período</th>`;
    headerHTML += '</tr>';

    // Segunda linha do cabeçalho com subcolunas
    headerHTML += '<tr><th></th>';
    meses.forEach(() => {
        headerHTML += `
            <th>Orçado</th>
            <th>Realizado</th>
            <th>% Atingido</th>
            <th>Diferença</th>
        `;
    });
    headerHTML += `
        <th class="col-total">Total Orçado</th>
        <th class="col-total">Total Realizado</th>
        <th class="col-total">Diferença</th>
    `;
    headerHTML += '</tr>';

    document.getElementById('table-header').innerHTML = headerHTML;

    // Gerar corpo da tabela
    let bodyHTML = '';

    itens.forEach(item => {
        bodyHTML += `<tr>`;

        // Coluna de descrição com hierarquia
        bodyHTML += `<td class="nivel-${item.nivel_hierarquia}">`;
        if (item.codigo) {
            bodyHTML += `<code>${item.codigo}</code> `;
        }
        bodyHTML += `${item.nome}</td>`;

        // Calcular totais
        let totalOrcado = 0;
        let totalRealizado = 0;

        // Dados mensais
        meses.forEach(mes => {
            const chave = `${mes.ano}_${mes.mes_numero}`;
            const dados = item.dados_mensais[chave];

            if (dados) {
                const orcado = dados.valor_orcado || 0;
                const realizado = dados.valor_realizado || 0;
                const perc = dados.perc_atingido || 0;
                const dif = dados.valor_diferenca || 0;

                totalOrcado += orcado;
                totalRealizado += realizado;

                bodyHTML += `
                    <td>${formatMoney(orcado)}</td>
                    <td>${formatMoney(realizado)}</td>
                    <td>${formatPercent(perc)}</td>
                    <td>${formatMoney(dif)}</td>
                `;
            } else {
                bodyHTML += `<td>-</td><td>-</td><td>-</td><td>-</td>`;
            }
        });

        // Totais
        const totalDif = totalOrcado - totalRealizado;
        bodyHTML += `
            <td class="col-total">${formatMoney(totalOrcado)}</td>
            <td class="col-total">${formatMoney(totalRealizado)}</td>
            <td class="col-total">${formatMoney(totalDif)}</td>
        `;

        bodyHTML += `</tr>`;
    });

    document.getElementById('table-body').innerHTML = bodyHTML;
}

function renderizarCenarios(data) {
    const { totais_calculados, meses } = data;

    // Cabeçalho dos cenários (colunas para cada mês)
    let headerCols = '';
    meses.forEach(mes => {
        headerCols += `<th>${mes.mes_nome} ${mes.ano}</th>`;
    });

    document.getElementById('fc-header').innerHTML = headerCols;
    document.getElementById('real-header').innerHTML = headerCols;
    document.getElementById('realmp-header').innerHTML = headerCols;

    // Renderizar cada cenário
    renderizarCenario('fluxo_caixa', 'fc-body', totais_calculados, meses);
    renderizarCenario('real', 'real-body', totais_calculados, meses);
    renderizarCenario('real_mp', 'realmp-body', totais_calculados, meses);
}

function renderizarCenario(tipo, bodyId, totais_calculados, meses) {
    const cenario = totais_calculados[tipo] || {};

    const categorias = ['Receita', 'Despesa', 'Geral'];
    const campos = ['orcamento', 'realizado', 'perc_atingido', 'diferenca'];
    const labels = {
        'orcamento': 'Orçamento',
        'realizado': 'Realizado',
        'perc_atingido': '% Atingido',
        'diferenca': 'Diferença'
    };

    let bodyHTML = '';

    campos.forEach(campo => {
        // Linha de título
        bodyHTML += `<tr style="background: #f8f9fa;"><td colspan="${meses.length + 1}"><strong>${labels[campo]}</strong></td></tr>`;

        categorias.forEach(cat => {
            const catKey = cat.toLowerCase();
            bodyHTML += `<tr><td>${cat}</td>`;

            meses.forEach(mes => {
                const chave = `${mes.ano}_${mes.mes_numero}`;
                const dados = cenario[chave];

                if (dados && dados[campo] && dados[campo][catKey] !== undefined) {
                    const valor = dados[campo][catKey];
                    if (campo === 'perc_atingido') {
                        bodyHTML += `<td>${formatPercent(valor)}</td>`;
                    } else {
                        bodyHTML += `<td>${formatMoney(valor)}</td>`;
                    }
                } else {
                    bodyHTML += `<td>-</td>`;
                }
            });

            bodyHTML += `</tr>`;
        });
    });

    document.getElementById(bodyId).innerHTML = bodyHTML;
}
</script>

{% endblock %}
