{% extends "admin/base.html" %}

{% block header_title %}Gerenciamento de Empresas{% endblock %}

{% block header_subtitle %}Cadastre empresas, faça upload e gerencie dados financeiros{% endblock %}

{% block content %}
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-orange" role="status">
            <span class="visually-hidden">Processando...</span>
        </div>
        <p class="text-light mt-3 fw-semibold">Processando dados, por favor, aguarde...</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-container mb-4">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- LISTAGEM DE EMPRESAS -->
    <div class="bg-white rounded-3 shadow p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="h5 fw-semibold text-dark mb-1">
                    <i class="bi bi-building-fill text-orange me-2"></i>
                    Empresas Cadastradas
                </h2>
                <p class="text-muted small mb-0">Total de {{ empresas|length }} empresa(s) cadastrada(s)</p>
            </div>
            <button class="btn btn-orange shadow-sm" data-bs-toggle="modal" data-bs-target="#addEmpresaModal">
                <i class="bi bi-plus-circle me-2"></i>
                Nova Empresa
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" class="fw-semibold"><i class="bi bi-building me-1"></i>Nome</th>
                        <th scope="col" class="fw-semibold"><i class="bi bi-credit-card me-1"></i>CNPJ</th>
                        <th scope="col" class="fw-semibold"><i class="bi bi-tag me-1"></i>Seguimento</th>
                        <th scope="col" class="fw-semibold text-center"><i class="bi bi-calendar-check me-1"></i>Anos com Dados</th>
                        <th scope="col" class="fw-semibold text-center"><i class="bi bi-calendar2-month me-1"></i>Dados BPO</th>
                        <th scope="col" class="fw-semibold text-center"><i class="bi bi-gear me-1"></i>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for empresa in empresas %}
                    <tr class="{% if not empresa.ativo %}table-secondary opacity-75{% endif %}">
                        <td class="fw-medium">
                            {{ empresa.nome }}
                            {% if not empresa.ativo %}
                                <span class="badge bg-danger ms-2">INATIVO</span>
                            {% endif %}
                        </td>
                        <td class="text-muted">{{ empresa.cnpj }}</td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                <i class="bi bi-briefcase-fill me-1"></i>
                                {{ empresa.seguimento }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% set anos = uploads.get(empresa.id, []) %}
                            {% if anos %}
                                <div class="d-flex flex-wrap justify-content-center gap-1">
                                    {% for ano in anos|sort(reverse=True) %}
                                        <span class="badge bg-success">{{ ano }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-muted small">Nenhum dado</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% set dados_bpo = uploads_bpo.get(empresa.id, {}) %}
                            {% if dados_bpo %}
                                <div class="d-flex flex-wrap justify-content-center gap-1">
                                    {% for ano in dados_bpo.keys()|sort(reverse=True) %}
                                        {% set meses = dados_bpo[ano] %}
                                        {% set meses_nomes = {1: 'Jan', 2: 'Fev', 3: 'Mar', 4: 'Abr', 5: 'Mai', 6: 'Jun', 7: 'Jul', 8: 'Ago', 9: 'Set', 10: 'Out', 11: 'Nov', 12: 'Dez'} %}
                                        {% set meses_str = [] %}
                                        {% for mes in meses|sort %}
                                            {% set _ = meses_str.append(meses_nomes[mes]) %}
                                        {% endfor %}
                                        <span class="badge bg-info text-dark position-relative"
                                              style="cursor: pointer;"
                                              data-bs-toggle="popover"
                                              data-bs-trigger="hover focus"
                                              data-bs-placement="top"
                                              data-bs-html="true"
                                              data-bs-content="<div style='max-height: 150px; overflow-y: auto;'><small>{{ meses_str|join(', ') }}</small></div>"
                                              title="Meses de {{ ano }}">
                                            {{ ano }} <span class="badge bg-dark rounded-pill">{{ meses|length }}</span>
                                        </span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-muted small">Nenhum dado</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('admin.dashboard_empresa', empresa_id=empresa.id) }}"
                                   class="btn btn-sm btn-outline-success {% if not empresa.ativo %}disabled{% endif %}"
                                   title="Dashboard Viabilidade">
                                    <i class="bi bi-graph-up-arrow"></i>
                                </a>
                                <a href="{{ url_for('admin.dashboard_bpo', empresa_id=empresa.id) }}"
                                   class="btn btn-sm btn-outline-primary {% if not empresa.ativo %}disabled{% endif %}"
                                   title="Dashboard BPO">
                                    <i class="bi bi-bar-chart-line"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-info"
                                        onclick="abrirUploadModal({{ empresa.id }}, '{{ empresa.nome }}')"
                                        title="Upload de dados"
                                        {% if not empresa.ativo %}disabled{% endif %}>
                                    <i class="bi bi-upload"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning"
                                        onclick="abrirGerenciarDados({{ empresa.id }}, '{{ empresa.nome }}', {{ anos|tojson }})"
                                        title="Gerenciar dados"
                                        {% if not empresa.ativo %}disabled{% endif %}>
                                    <i class="bi bi-database"></i>
                                </button>
                                <a href="{{ url_for('admin.consultar_dados_bpo') }}?empresa_id={{ empresa.id }}"
                                   class="btn btn-sm btn-outline-secondary {% if not empresa.ativo %}disabled{% endif %}"
                                   title="Ver dados BPO">
                                    <i class="bi bi-calendar-check"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-primary btn-edit-empresa"
                                        data-id="{{ empresa.id }}"
                                        data-nome="{{ empresa.nome }}"
                                        data-cnpj="{{ empresa.cnpj }}"
                                        data-telefone="{{ empresa.telefone }}"
                                        data-email="{{ empresa.email }}"
                                        data-cep="{{ empresa.cep }}"
                                        data-seguimento="{{ empresa.seguimento }}"
                                        data-website="{{ empresa.website or '' }}"
                                        data-complemento="{{ empresa.complemento or '' }}"
                                        title="Editar empresa"
                                        {% if not empresa.ativo %}disabled{% endif %}>
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                {% if empresa.ativo %}
                                <button class="btn btn-sm btn-outline-secondary"
                                        onclick="confirmarInativar({{ empresa.id }}, '{{ empresa.nome }}')"
                                        title="Inativar empresa">
                                    <i class="bi bi-archive"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-success"
                                        onclick="confirmarAtivar({{ empresa.id }}, '{{ empresa.nome }}')"
                                        title="Ativar empresa">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="showDeleteEmpresaModal({{ empresa.id }}, '{{ empresa.nome }}')"
                                        title="Excluir empresa">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox display-4 d-block mb-3"></i>
                            <p class="mb-0">Nenhuma empresa cadastrada ainda.</p>
                            <small>Clique em "Nova Empresa" para adicionar a primeira empresa.</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<!-- MODAL ADICIONAR EMPRESA -->
<div class="modal fade" id="addEmpresaModal" tabindex="-1" aria-labelledby="addEmpresaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" method="post" action="{{ url_for('admin.cadastrar_empresa') }}">
            <div class="modal-header bg-orange text-white">
                <h5 class="modal-title" id="addEmpresaModalLabel">
                    <i class="bi bi-building-fill-add me-2"></i>
                    Cadastrar Nova Empresa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="nome" class="form-label">Nome da Empresa *</label>
                        <input type="text" class="form-control" id="nome" name="nome" required>
                    </div>
                    <div class="col-md-4">
                        <label for="cnpj" class="form-label">CNPJ *</label>
                        <input type="text" class="form-control" id="cnpj" name="cnpj" placeholder="XX.XXX.XXX/XXXX-XX" required>
                    </div>
                    <div class="col-md-6">
                        <label for="telefone" class="form-label">Telefone *</label>
                        <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="(XX) XXXXX-XXXX" required>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="col-md-4">
                        <label for="cep" class="form-label">CEP *</label>
                        <input type="text" class="form-control" id="cep" name="cep" placeholder="XXXXX-XXX" required>
                    </div>
                    <div class="col-md-4">
                        <label for="seguimento" class="form-label">Seguimento *</label>
                        <input type="text" class="form-control" id="seguimento" name="seguimento" placeholder="Ex: Varejo" required>
                    </div>
                    <div class="col-md-4">
                        <label for="website" class="form-label">Website</label>
                        <input type="url" class="form-control" id="website" name="website" placeholder="https://">
                    </div>
                    <div class="col-12">
                        <label for="complemento" class="form-label">Complemento de Endereço</label>
                        <textarea class="form-control" id="complemento" name="complemento" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-orange">
                    <i class="bi bi-check-circle me-1"></i>Cadastrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL EDITAR EMPRESA -->
<div class="modal fade" id="editEmpresaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" method="post" action="{{ url_for('admin.editar_empresa') }}">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Empresa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEmpresaId" name="id">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="editNome" class="form-label">Nome da Empresa *</label>
                        <input type="text" class="form-control" id="editNome" name="nome" required>
                    </div>
                    <div class="col-md-4">
                        <label for="editCnpj" class="form-label">CNPJ *</label>
                        <input type="text" class="form-control" id="editCnpj" name="cnpj" required>
                    </div>
                    <div class="col-md-6">
                        <label for="editTelefone" class="form-label">Telefone *</label>
                        <input type="tel" class="form-control" id="editTelefone" name="telefone" required>
                    </div>
                    <div class="col-md-6">
                        <label for="editEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    <div class="col-md-4">
                        <label for="editCep" class="form-label">CEP *</label>
                        <input type="text" class="form-control" id="editCep" name="cep" required>
                    </div>
                    <div class="col-md-4">
                        <label for="editSeguimento" class="form-label">Seguimento *</label>
                        <input type="text" class="form-control" id="editSeguimento" name="seguimento" required>
                    </div>
                    <div class="col-md-4">
                        <label for="editWebsite" class="form-label">Website</label>
                        <input type="url" class="form-control" id="editWebsite" name="website">
                    </div>
                    <div class="col-12">
                        <label for="editComplemento" class="form-label">Complemento</label>
                        <textarea class="form-control" id="editComplemento" name="complemento" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL DELETE EMPRESA -->
<div class="modal fade" id="deleteEmpresaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir a empresa <strong id="deleteEmpresaNome"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Atenção:</strong> Todos os dados financeiros vinculados a esta empresa serão excluídos permanentemente!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="#" id="confirmDeleteEmpresaButton" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i>Excluir
                </a>
            </div>
        </div>
    </div>
</div>

<!-- MODAL UPLOAD DADOS - COM TABS PARA VIABILIDADE E BPO -->
<div class="modal fade" id="uploadDadosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-upload me-2"></i>Upload de Dados Financeiros
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="mb-2">Empresa: <strong id="uploadEmpresaNome"></strong></p>
                    <div class="alert alert-info py-2 px-3 mb-0">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Viabilidade:</strong> Dados anuais | <strong>BPO:</strong> Dados mensais
                        </small>
                    </div>
                </div>

                <!-- TABS DE NAVEGAÇÃO -->
                <ul class="nav nav-tabs mb-3" id="uploadTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="viabilidade-tab" data-bs-toggle="tab"
                                data-bs-target="#viabilidade-content" type="button" role="tab">
                            <i class="bi bi-graph-up me-1"></i>
                            Viabilidade Financeira
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bpo-tab" data-bs-toggle="tab"
                                data-bs-target="#bpo-content" type="button" role="tab">
                            <i class="bi bi-calendar-month me-1"></i>
                            BPO Financeiro
                        </button>
                    </li>
                </ul>

                <!-- CONTEÚDO DAS TABS -->
                <div class="tab-content" id="uploadTabsContent">

                    <!-- TAB 1: VIABILIDADE FINANCEIRA (ANUAL) -->
                    <div class="tab-pane fade show active" id="viabilidade-content" role="tabpanel">
                        <form id="upload-form-viabilidade" method="post"
                              action="{{ url_for('admin.upload_dados') }}"
                              enctype="multipart/form-data">
                            <input type="hidden" id="uploadEmpresaIdViabilidade" name="empresa_id">

                            <div class="alert alert-light border">
                                <h6 class="fw-semibold mb-2">
                                    <i class="bi bi-bar-chart-line text-primary me-1"></i>
                                    Dados de Viabilidade Financeira
                                </h6>
                                <p class="small text-muted mb-0">
                                    Upload de dados anuais de viabilidade financeira da empresa.
                                    Os dados são processados por cenários (Real, Ponto de Equilíbrio, Ideal).
                                </p>
                            </div>

                            <div class="mb-3">
                                <label for="anoInputViabilidade" class="form-label">
                                    <i class="bi bi-calendar4 me-1"></i>Ano *
                                </label>
                                <input type="number" class="form-control" id="anoInputViabilidade"
                                       name="ano" min="2000" max="2100" value="2025" required>
                            </div>

                            <div class="mb-3">
                                <label for="arquivoUploadViabilidade" class="form-label">
                                    <i class="bi bi-file-earmark-excel me-1"></i>Arquivo Excel *
                                </label>
                                <input type="file" class="form-control" id="arquivoUploadViabilidade"
                                       name="arquivo" accept=".xlsx,.xls" required>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Formatos aceitos: .xlsx, .xls
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload me-2"></i>Enviar Dados de Viabilidade
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- TAB 2: BPO FINANCEIRO (MENSAL) -->
                    <div class="tab-pane fade" id="bpo-content" role="tabpanel">
                        <form id="upload-form-bpo" method="post"
                              action="{{ url_for('admin.upload_dados_bpo') }}"
                              enctype="multipart/form-data">
                            <input type="hidden" id="uploadEmpresaIdBpo" name="empresa_id">

                            <div class="alert alert-light border">
                                <h6 class="fw-semibold mb-2">
                                    <i class="bi bi-calendar-range text-success me-1"></i>
                                    Dados de BPO Financeiro
                                </h6>
                                <p class="small text-muted mb-0">
                                    Upload de dados mensais de BPO (Business Process Outsourcing) financeiro.
                                    O sistema detectará automaticamente os meses e anos do cabeçalho da planilha
                                    e salvará cada um separadamente.
                                </p>
                            </div>

                            <div class="mb-3">
                                <label for="arquivoUploadBpo" class="form-label">
                                    <i class="bi bi-file-earmark-excel me-1"></i>Arquivo Excel *
                                </label>
                                <input type="file" class="form-control" id="arquivoUploadBpo"
                                       name="arquivo" accept=".xlsx,.xls" required>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Formatos aceitos: .xlsx, .xls
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-upload me-2"></i>Enviar Dados de BPO
                                </button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL GERENCIAR DADOS -->
<div class="modal fade" id="gerenciarDadosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-folder-open me-2"></i>Gerenciar Dados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Empresa: <strong id="gerenciarEmpresaNome"></strong></p>

                <!-- TABS -->
                <ul class="nav nav-tabs mb-3" id="gerenciarTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="viabilidade-tab" data-bs-toggle="tab" data-bs-target="#viabilidade-panel" type="button" role="tab">
                            <i class="bi bi-clipboard-data me-1"></i>Viabilidade
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bpo-tab" data-bs-toggle="tab" data-bs-target="#bpo-panel" type="button" role="tab" onclick="if(empresaIdAtual) { carregarMesesBpo(empresaIdAtual); }">
                            <i class="bi bi-calendar-month me-1"></i>BPO
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="gerenciarTabsContent">
                    <!-- ABA VIABILIDADE -->
                    <div class="tab-pane fade show active" id="viabilidade-panel" role="tabpanel">
                        <div class="mb-3">
                            <label for="anoSelectGerenciar" class="form-label">Selecione o Ano:</label>
                            <select class="form-select" id="anoSelectGerenciar" onchange="atualizarFormsAno()">
                                <option value="">-- Selecione um ano --</option>
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <form method="POST" action="{{ url_for('admin.consultar_dados') }}">
                                <input type="hidden" name="empresa_id" id="formVerEmpresaId">
                                <input type="hidden" name="ano" id="formVerAno">
                                <button type="submit" class="btn btn-primary w-100" id="btnVerDados" disabled>
                                    <i class="bi bi-eye me-2"></i>Ver Dados
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('admin.deletar_dados_empresa') }}"
                                  onsubmit="return confirm('Tem certeza que deseja excluir estes dados de VIABILIDADE? Esta ação não pode ser desfeita.');">
                                <input type="hidden" name="empresa_id" id="formExcluirEmpresaId">
                                <input type="hidden" name="ano" id="formExcluirAno">
                                <button type="submit" class="btn btn-danger w-100" id="btnExcluirDados" disabled>
                                    <i class="bi bi-trash me-2"></i>Excluir Dados
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- ABA BPO -->
                    <div class="tab-pane fade" id="bpo-panel" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Selecione os meses para excluir:</label>
                            <div id="mesesBpoContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <p class="text-muted">Carregando meses disponíveis...</p>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="button" class="btn btn-danger" id="btnExcluirMesesBpo" onclick="excluirMesesBpo()" disabled>
                                <i class="bi bi-trash me-2"></i>Excluir Meses Selecionados
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.4s ease;
    }

    .loading-overlay.active {
        visibility: visible;
        opacity: 1;
    }

    .spinner-border {
        width: 3.5rem;
        height: 3.5rem;
    }

    .text-orange {
        color: #ff9900 !important;
    }
</style>

<script>
// ===== MÁSCARAS E VALIDAÇÕES =====

// Máscara para CNPJ: XX.XXX.XXX/XXXX-XX
function maskCNPJ(value) {
    return value
        .replace(/\D/g, '')
        .replace(/^(\d{2})(\d)/, '$1.$2')
        .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
        .replace(/\.(\d{3})(\d)/, '.$1/$2')
        .replace(/(\d{4})(\d)/, '$1-$2')
        .substring(0, 18);
}

// Máscara para telefone: (XX) XXXXX-XXXX
function maskTelefone(value) {
    return value
        .replace(/\D/g, '')
        .replace(/^(\d{2})(\d)/, '($1) $2')
        .replace(/(\d{5})(\d)/, '$1-$2')
        .substring(0, 15);
}

// Máscara para CEP: XXXXX-XXX
function maskCEP(value) {
    return value
        .replace(/\D/g, '')
        .replace(/^(\d{5})(\d)/, '$1-$2')
        .substring(0, 9);
}

// Validação de CNPJ
function validarCNPJ(cnpj) {
    // Validação simplificada: apenas verifica se tem 14 dígitos
    // Permite CNPJs inválidos para facilitar testes e cadastros de filiais
    cnpj = cnpj.replace(/\D/g, '');
    return cnpj.length === 14;
}

// Validação de telefone
function validarTelefone(telefone) {
    const numeros = telefone.replace(/\D/g, '');
    return numeros.length === 10 || numeros.length === 11;
}

// Validação de CEP
function validarCEP(cep) {
    const numeros = cep.replace(/\D/g, '');
    return numeros.length === 8;
}

// Validação de email
function validarEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
}

function showEditEmpresaModal(empresa) {
    const modal = new bootstrap.Modal(document.getElementById('editEmpresaModal'));
    document.getElementById('editEmpresaId').value = empresa.id;
    document.getElementById('editNome').value = empresa.nome;
    document.getElementById('editCnpj').value = empresa.cnpj;
    document.getElementById('editTelefone').value = empresa.telefone;
    document.getElementById('editEmail').value = empresa.email;
    document.getElementById('editCep').value = empresa.cep;
    document.getElementById('editSeguimento').value = empresa.seguimento;
    document.getElementById('editWebsite').value = empresa.website || '';
    document.getElementById('editComplemento').value = empresa.complemento || '';
    modal.show();
}

function showDeleteEmpresaModal(id, nome) {
    const modal = new bootstrap.Modal(document.getElementById('deleteEmpresaModal'));
    document.getElementById('deleteEmpresaNome').textContent = nome;
    document.getElementById('confirmDeleteEmpresaButton').href = `/admin/deletar_empresa/${id}`;
    modal.show();
}

function confirmarInativar(id, nome) {
    if (confirm(`Tem certeza que deseja INATIVAR a empresa "${nome}"?\n\nA empresa ficará desabilitada mas todos os dados serão preservados.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/inativar_empresa/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmarAtivar(id, nome) {
    if (confirm(`Tem certeza que deseja ATIVAR a empresa "${nome}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/ativar_empresa/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function abrirUploadModal(empresaId, empresaNome) {
    const modal = new bootstrap.Modal(document.getElementById('uploadDadosModal'));

    // Preencher nome da empresa
    document.getElementById('uploadEmpresaNome').textContent = empresaNome;

    // Preencher empresa_id nos dois formulários (Viabilidade e BPO)
    document.getElementById('uploadEmpresaIdViabilidade').value = empresaId;
    document.getElementById('uploadEmpresaIdBpo').value = empresaId;

    // Reset para a primeira tab (Viabilidade)
    const viabilidadeTab = document.getElementById('viabilidade-tab');
    const viabilidadeContent = document.getElementById('viabilidade-content');
    const bpoContent = document.getElementById('bpo-content');

    viabilidadeTab.classList.add('active');
    viabilidadeContent.classList.add('show', 'active');
    bpoContent.classList.remove('show', 'active');

    modal.show();
}

let empresaIdAtual = null;

function abrirGerenciarDados(empresaId, empresaNome, anos) {
    empresaIdAtual = empresaId;
    const modal = new bootstrap.Modal(document.getElementById('gerenciarDadosModal'));
    document.getElementById('gerenciarEmpresaNome').textContent = empresaNome;

    const select = document.getElementById('anoSelectGerenciar');
    select.innerHTML = '<option value="">-- Selecione um ano --</option>';

    if (anos && anos.length > 0) {
        anos.sort((a, b) => b - a);
        anos.forEach(ano => {
            const option = document.createElement('option');
            option.value = ano;
            option.textContent = ano;
            select.appendChild(option);
        });
    }

    document.getElementById('formVerEmpresaId').value = empresaId;
    document.getElementById('formExcluirEmpresaId').value = empresaId;
    document.getElementById('btnVerDados').disabled = true;
    document.getElementById('btnExcluirDados').disabled = true;

    // Garantir que voltamos para a aba Viabilidade
    const viabilidadeTab = document.getElementById('viabilidade-tab');
    const viabilidadePanel = document.getElementById('viabilidade-panel');
    const bpoPanel = document.getElementById('bpo-panel');

    // Ativar aba de Viabilidade
    viabilidadeTab.classList.add('active');
    viabilidadePanel.classList.add('show', 'active');
    bpoPanel.classList.remove('show', 'active');

    modal.show();
}

function atualizarFormsAno() {
    const anoSelecionado = document.getElementById('anoSelectGerenciar').value;

    if (anoSelecionado) {
        document.getElementById('formVerAno').value = anoSelecionado;
        document.getElementById('formExcluirAno').value = anoSelecionado;
        document.getElementById('btnVerDados').disabled = false;
        document.getElementById('btnExcluirDados').disabled = false;
    } else {
        document.getElementById('btnVerDados').disabled = true;
        document.getElementById('btnExcluirDados').disabled = true;
    }
}

// ========== FUNÇÕES BPO ==========

async function carregarMesesBpo(empresaId) {
    const container = document.getElementById('mesesBpoContainer');
    container.innerHTML = '<p class="text-muted"><i class="bi bi-hourglass-split me-2"></i>Carregando meses...</p>';

    try {
        const response = await fetch(`/admin/api/listar-meses-bpo/${empresaId}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (!data.sucesso) {
            container.innerHTML = `<p class="text-danger"><i class="bi bi-exclamation-triangle me-2"></i>${data.mensagem}</p>`;
            return;
        }

        if (data.meses.length === 0) {
            container.innerHTML = '<p class="text-muted"><i class="bi bi-inbox me-2"></i>Nenhum mês de BPO encontrado.</p>';
            return;
        }

        // Agrupar por ano
        const mesesPorAno = {};
        data.meses.forEach(item => {
            if (!mesesPorAno[item.ano]) {
                mesesPorAno[item.ano] = [];
            }
            mesesPorAno[item.ano].push(item.mes);
        });

        // Nomes dos meses
        const nomesMeses = {
            1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
            5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
            9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
        };

        // Renderizar checkboxes
        let html = '';
        Object.keys(mesesPorAno).sort((a, b) => b - a).forEach(ano => {
            html += `<div class="mb-3">
                <h6 class="fw-bold text-primary">${ano}</h6>`;

            mesesPorAno[ano].sort((a, b) => a - b).forEach(mes => {
                html += `
                <div class="form-check">
                    <input class="form-check-input mes-bpo-checkbox" type="checkbox" value="${ano}-${mes}" id="mes-${ano}-${mes}">
                    <label class="form-check-label" for="mes-${ano}-${mes}">
                        ${nomesMeses[mes]}/${ano}
                    </label>
                </div>`;
            });

            html += '</div>';
        });

        container.innerHTML = html;

        // Adicionar listener para habilitar/desabilitar botão
        document.querySelectorAll('.mes-bpo-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', atualizarBotaoExcluirBpo);
        });

    } catch (error) {
        console.error('Erro ao carregar meses BPO:', error);
        container.innerHTML = '<p class="text-danger"><i class="bi bi-x-circle me-2"></i>Erro ao carregar meses.</p>';
    }
}

function atualizarBotaoExcluirBpo() {
    const checkboxes = document.querySelectorAll('.mes-bpo-checkbox:checked');
    document.getElementById('btnExcluirMesesBpo').disabled = checkboxes.length === 0;
}

async function excluirMesesBpo() {
    const checkboxes = document.querySelectorAll('.mes-bpo-checkbox:checked');
    const mesesSelecionados = Array.from(checkboxes).map(cb => cb.value);

    if (mesesSelecionados.length === 0) {
        alert('Selecione pelo menos um mês para excluir.');
        return;
    }

    const confirmar = confirm(`Tem certeza que deseja excluir ${mesesSelecionados.length} mês(es) de BPO? Esta ação não pode ser desfeita.`);
    if (!confirmar) return;

    try {
        const response = await fetch('/admin/api/excluir-meses-bpo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                empresa_id: empresaIdAtual,
                meses: mesesSelecionados
            })
        });

        const data = await response.json();

        if (data.sucesso) {
            alert(`${data.excluidos} mês(es) excluído(s) com sucesso!`);
            carregarMesesBpo(empresaIdAtual);  // Recarregar lista
            location.reload();  // Recarregar página para atualizar contadores
        } else {
            alert(`Erro: ${data.mensagem}`);
        }
    } catch (error) {
        console.error('Erro ao excluir meses:', error);
        alert('Erro ao excluir meses. Tente novamente.');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar popovers do Bootstrap para mostrar meses de BPO
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    const popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });

    // Loading overlay para AMBOS os formulários de upload
    const uploadFormViabilidade = document.getElementById('upload-form-viabilidade');
    const uploadFormBpo = document.getElementById('upload-form-bpo');
    const loadingOverlay = document.getElementById('loading-overlay');

    // Adicionar loading ao form de Viabilidade
    if (uploadFormViabilidade && loadingOverlay) {
        uploadFormViabilidade.addEventListener('submit', function() {
            loadingOverlay.classList.add('active');
        });
    }

    // Adicionar loading ao form de BPO
    if (uploadFormBpo && loadingOverlay) {
        uploadFormBpo.addEventListener('submit', function() {
            loadingOverlay.classList.add('active');
        });
    }

    // Event delegation para botões de editar empresa
    document.querySelectorAll('.btn-edit-empresa').forEach(button => {
        button.addEventListener('click', function() {
            const empresa = {
                id: this.dataset.id,
                nome: this.dataset.nome,
                cnpj: this.dataset.cnpj,
                telefone: this.dataset.telefone,
                email: this.dataset.email,
                cep: this.dataset.cep,
                seguimento: this.dataset.seguimento,
                website: this.dataset.website,
                complemento: this.dataset.complemento
            };
            showEditEmpresaModal(empresa);
        });
    });

    // ===== APLICAR MÁSCARAS NO FORMULÁRIO DE ADICIONAR EMPRESA =====
    const cnpjInput = document.getElementById('cnpj');
    const telefoneInput = document.getElementById('telefone');
    const cepInput = document.getElementById('cep');
    const emailInput = document.getElementById('email');

    // Máscara CNPJ
    if (cnpjInput) {
        cnpjInput.addEventListener('input', function(e) {
            e.target.value = maskCNPJ(e.target.value);
        });
    }

    // Máscara Telefone
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function(e) {
            e.target.value = maskTelefone(e.target.value);
        });
    }

    // Máscara CEP
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            e.target.value = maskCEP(e.target.value);
        });
    }

    // ===== MÁSCARAS NO FORMULÁRIO DE EDITAR EMPRESA =====
    const editCnpjInput = document.getElementById('editCnpj');
    const editTelefoneInput = document.getElementById('editTelefone');
    const editCepInput = document.getElementById('editCep');

    if (editCnpjInput) {
        editCnpjInput.addEventListener('input', function(e) {
            e.target.value = maskCNPJ(e.target.value);
        });
    }

    if (editTelefoneInput) {
        editTelefoneInput.addEventListener('input', function(e) {
            e.target.value = maskTelefone(e.target.value);
        });
    }

    if (editCepInput) {
        editCepInput.addEventListener('input', function(e) {
            e.target.value = maskCEP(e.target.value);
        });
    }

    // ===== VALIDAÇÃO NO SUBMIT DO FORMULÁRIO DE ADICIONAR EMPRESA =====
    const addEmpresaForm = document.querySelector('#addEmpresaModal form');
    if (addEmpresaForm) {
        addEmpresaForm.addEventListener('submit', function(e) {
            const nome = document.getElementById('nome').value.trim();
            const cnpj = document.getElementById('cnpj').value;
            const telefone = document.getElementById('telefone').value;
            const email = document.getElementById('email').value.trim();
            const cep = document.getElementById('cep').value;
            const seguimento = document.getElementById('seguimento').value.trim();

            // Validar campos obrigatórios
            if (!nome) {
                e.preventDefault();
                alert('Por favor, preencha o nome da empresa.');
                return false;
            }

            // Validar CNPJ
            if (!validarCNPJ(cnpj)) {
                e.preventDefault();
                alert('CNPJ inválido. Por favor, verifique o número digitado.');
                document.getElementById('cnpj').focus();
                return false;
            }

            // Validar telefone
            if (!validarTelefone(telefone)) {
                e.preventDefault();
                alert('Telefone inválido. Use o formato (XX) XXXXX-XXXX.');
                document.getElementById('telefone').focus();
                return false;
            }

            // Validar email
            if (!validarEmail(email)) {
                e.preventDefault();
                alert('Email inválido. Por favor, verifique o endereço de email.');
                document.getElementById('email').focus();
                return false;
            }

            // Validar CEP
            if (!validarCEP(cep)) {
                e.preventDefault();
                alert('CEP inválido. Use o formato XXXXX-XXX.');
                document.getElementById('cep').focus();
                return false;
            }

            // Validar seguimento
            if (!seguimento) {
                e.preventDefault();
                alert('Por favor, preencha o seguimento da empresa.');
                return false;
            }

            return true;
        });
    }

    // ===== VALIDAÇÃO NO SUBMIT DO FORMULÁRIO DE EDITAR EMPRESA =====
    const editEmpresaForm = document.querySelector('#editEmpresaModal form');
    if (editEmpresaForm) {
        editEmpresaForm.addEventListener('submit', function(e) {
            const nome = document.getElementById('editNome').value.trim();
            const cnpj = document.getElementById('editCnpj').value;
            const telefone = document.getElementById('editTelefone').value;
            const email = document.getElementById('editEmail').value.trim();
            const cep = document.getElementById('editCep').value;
            const seguimento = document.getElementById('editSeguimento').value.trim();

            if (!nome) {
                e.preventDefault();
                alert('Por favor, preencha o nome da empresa.');
                return false;
            }

            if (!validarCNPJ(cnpj)) {
                e.preventDefault();
                alert('CNPJ inválido. Por favor, verifique o número digitado.');
                document.getElementById('editCnpj').focus();
                return false;
            }

            if (!validarTelefone(telefone)) {
                e.preventDefault();
                alert('Telefone inválido. Use o formato (XX) XXXXX-XXXX.');
                document.getElementById('editTelefone').focus();
                return false;
            }

            if (!validarEmail(email)) {
                e.preventDefault();
                alert('Email inválido. Por favor, verifique o endereço de email.');
                document.getElementById('editEmail').focus();
                return false;
            }

            if (!validarCEP(cep)) {
                e.preventDefault();
                alert('CEP inválido. Use o formato XXXXX-XXX.');
                document.getElementById('editCep').focus();
                return false;
            }

            if (!seguimento) {
                e.preventDefault();
                alert('Por favor, preencha o seguimento da empresa.');
                return false;
            }

            return true;
        });
    }
});
</script>
{% endblock %}
