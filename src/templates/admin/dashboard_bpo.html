{% extends "admin/base.html" %}

{% block header_title %}Dashboard BPO - {{ empresa.nome }}{% endblock %}
{% block header_subtitle %}Visualiza√ß√£o de dados mensais{% endblock %}

{% block content %}

<style>
:root {
    --bpo-primary: #6366f1;
    --bpo-success: #10b981;
    --bpo-danger: #ef4444;
    --bpo-warning: #f59e0b;
    --bpo-info: #3b82f6;
    --bpo-purple: #8b5cf6;
}

.table-categorias thead th {
    color: #000 !important;
    background-color: #f8f9fa;
}

/* Banner */
.bpo-banner {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-left: 4px solid var(--bpo-primary);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
}

.bpo-banner h5 {
    color: #1e3a8a;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.bpo-banner p {
    color: #1e40af;
    margin-bottom: 0;
}

/* Cards de filtro */
.filter-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.filter-card:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.filter-card h5 {
    color: #1e293b;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Cards DRE */
.dre-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border: 1px solid #e2e8f0;
    position: relative;
    overflow: hidden;
    height: 100%;
}

.dre-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.dre-card.fluxo-caixa::before {
    background: linear-gradient(90deg, var(--bpo-primary), var(--bpo-info));
}

.dre-card.real::before {
    background: linear-gradient(90deg, var(--bpo-success), #059669);
}

.dre-card.real-mp::before {
    background: linear-gradient(90deg, var(--bpo-purple), #7c3aed);
}

.dre-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}

.dre-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.dre-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.dre-card.fluxo-caixa .dre-icon {
    background: linear-gradient(135deg, var(--bpo-primary), var(--bpo-info));
}

.dre-card.real .dre-icon {
    background: linear-gradient(135deg, var(--bpo-success), #059669);
}

.dre-card.real-mp .dre-icon {
    background: linear-gradient(135deg, var(--bpo-purple), #7c3aed);
}

.dre-card h6 {
    color: #1e293b;
    font-weight: 700;
    font-size: 1.1rem;
    margin: 0;
}

.dre-metric {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f5f9;
    color: #64748b;
    font-size: 0.9rem;
}

.dre-metric:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.dre-metric strong {
    color: #1e293b;
    font-weight: 600;
}

/* T√≠tulos de se√ß√£o */
.section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    margin-top: 2rem;
}

.section-header h5 {
    color: #1e293b;
    font-weight: 700;
    font-size: 1.5rem;
    margin: 0;
}

.section-header i {
    color: var(--bpo-primary);
    font-size: 1.75rem;
}

/* Cards de gr√°ficos */
.chart-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    overflow: hidden;
}

.chart-card:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.chart-card .card-body h6 {
    color: #1e293b;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Tabela estilizada */
.styled-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.styled-table thead th {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    color: #1e293b;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    padding: 1rem;
    border: none;
}

.styled-table tbody th {
    background: #f8fafc;
    color: #1e293b;
    font-weight: 600;
}

.styled-table tbody td {
    padding: 0.875rem 1rem;
    color: #64748b;
}

.styled-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
}

.styled-table tbody tr:last-child {
    border-bottom: none;
}

.styled-table tbody tr:hover {
    background: #f8fafc;
}

/* Bot√£o de filtrar */
.btn-filter {
    background: linear-gradient(135deg, var(--bpo-primary), var(--bpo-info));
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.625rem 1.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.btn-filter:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    background: linear-gradient(135deg, #4f46e5, #2563eb);
    color: white;
}

/* Form controls */
.form-label {
    color: #475569;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.form-select, .form-control {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.625rem 0.875rem;
    transition: all 0.2s ease;
}

.form-select:focus, .form-control:focus {
    border-color: var(--bpo-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}
</style>

<!-- Banner BPO -->
<div class="bpo-banner">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h5>
                <i class="bi bi-graph-up-arrow me-2"></i>
                Dashboard BPO - <strong>{{ empresa.nome }}</strong>
            </h5>
            <p class="small">
                An√°lise detalhada de receitas, despesas e resultados mensais
            </p>
        </div>
        {% if is_user_view %}
        <a href="{{ url_for('user.user_dashboard') }}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i> Voltar ao Dashboard
        </a>
        {% else %}
        <a href="{{ url_for('admin.gerenciar_empresas') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Voltar para Empresas
        </a>
        {% endif %}
    </div>
</div>

<div class="container-fluid px-4">
    <!-- FILTROS -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-funnel"></i>
                    Filtros de Per√≠odo
                </h5>
                <button id="btn-exportar-pdf" class="btn btn-danger" onclick="exportarDashboardPDF()" style="display: none;">
                    <i class="bi bi-file-pdf-fill me-2"></i>Baixar PDF
                </button>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Tipo de DRE</label>
                    <select id="tipo_dre" class="form-select">
                        <option value="fluxo_caixa">Resultado por Fluxo de Caixa</option>
                        <option value="real">Resultado Real</option>
                        <option value="real_mp">Resultado Real + Custo MP</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">M√™s In√≠cio</label>
                    <select id="mes_inicio" class="form-select">
                        {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ano In√≠cio</label>
                    <input type="number" id="ano_inicio" class="form-control" value="2025" min="2000" max="2100">
                </div>
                <div class="col-md-2">
                    <label class="form-label">M√™s Fim</label>
                    <select id="mes_fim" class="form-select">
                        {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if i == 12 %}selected{% endif %}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ano Fim</label>
                    <input type="number" id="ano_fim" class="form-control" value="2025" min="2000" max="2100">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-filter w-100" onclick="atualizarDados()">
                        <i class="bi bi-search me-1"></i>
                        Filtrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- RESULTADO GERAL -->
    <div class="section-header">
        <i class="bi bi-clipboard-data"></i>
        <h5>Resultado Geral</h5>
    </div>

    <!-- 3 CARDS DOS DREs -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="dre-card fluxo-caixa">
                <div class="dre-card-header">
                    <div class="dre-icon">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <h6>Resultado por Fluxo de Caixa</h6>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-up-circle me-1"></i>Receita:</span>
                    <strong id="card_fc_rec">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-down-circle me-1"></i>Despesa:</span>
                    <strong id="card_fc_desp">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-graph-up me-1"></i>Resultado:</span>
                    <strong id="card_fc_ger">R$ 0,00</strong>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dre-card real">
                <div class="dre-card-header">
                    <div class="dre-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <h6>Resultado Real</h6>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-up-circle me-1"></i>Receita:</span>
                    <strong id="card_real_rec">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-down-circle me-1"></i>Despesa:</span>
                    <strong id="card_real_desp">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-graph-up me-1"></i>Resultado:</span>
                    <strong id="card_real_ger">R$ 0,00</strong>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dre-card real-mp">
                <div class="dre-card-header">
                    <div class="dre-icon">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <h6>Resultado Real + Custo MP</h6>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-up-circle me-1"></i>Receita:</span>
                    <strong id="card_mp_rec">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-down-circle me-1"></i>Despesa:</span>
                    <strong id="card_mp_desp">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-graph-up me-1"></i>Resultado:</span>
                    <strong id="card_mp_ger">R$ 0,00</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- TABELA DO DRE SELECIONADO -->
    <div class="table-responsive mb-4">
        <table class="table styled-table">
            <thead>
                <tr>
                    <th></th>
                    <th>M√©dia Prevista</th>
                    <th>M√©dia Realizada</th>
                    <th>Diferen√ßa</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Total Receitas</th>
                    <td id="tab_rec_prev">R$ 0,00</td>
                    <td id="tab_rec_real">R$ 0,00</td>
                    <td id="tab_rec_dif">R$ 0,00</td>
                </tr>
                <tr>
                    <th>Total Despesas</th>
                    <td id="tab_desp_prev">R$ 0,00</td>
                    <td id="tab_desp_real">R$ 0,00</td>
                    <td id="tab_desp_dif">R$ 0,00</td>
                </tr>
                <tr>
                    <th>Total Resultado</th>
                    <td id="tab_res_prev">R$ 0,00</td>
                    <td id="tab_res_real">R$ 0,00</td>
                    <td id="tab_res_dif">R$ 0,00</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="section-header">
        <i class="bi bi-bar-chart-line"></i>
        <h5>Evolu√ß√£o Mensal</h5>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card chart-card">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-arrow-up-circle-fill" style="color: var(--bpo-success);"></i>
                        Receitas
                    </h6>
                    <canvas id="chartReceita"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 mb-4">
            <div class="card chart-card">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-arrow-down-circle-fill" style="color: var(--bpo-danger);"></i>
                        Despesas
                    </h6>
                    <canvas id="chartDespesa"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 mb-4">
            <div class="card chart-card">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-graph-up-arrow" style="color: var(--bpo-primary);"></i>
                        Resultados
                    </h6>
                    <canvas id="chartGeral"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- CATEGORIAS DE DESPESA -->
    <div class="section-header">
        <i class="bi bi-pie-chart"></i>
        <h5>Despesas por Categorias</h5>
    </div>
    <div class="row mb-4">
        <!-- Gr√°fico de Pizza -->
        <div class="col-md-6 d-flex">
            <div class="card chart-card w-100">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-pie-chart-fill" style="color: var(--bpo-danger);"></i>
                        Gr√°fico
                    </h6>
                    <canvas id="chartPizzaDespesa"></canvas>
                </div>
            </div>
        </div>
        <!-- Tabela -->
        <div class="col-md-6 d-flex">
            <div class="card chart-card w-100">
                <div class="card-body d-flex flex-column">
                    <h6>
                        <i class="bi bi-table" style="color: var(--bpo-danger);"></i>
                        Detalhamento
                    </h6>
                    <div class="table-responsive flex-grow-1" style="max-height: 450px; overflow-y: auto;">
                        <table class="table table-hover table-categorias">
                            <thead class="sticky-top">
                                <tr>
                                    <th>Natureza</th>
                                    <th>M√©dia Prevista</th>
                                    <th>M√©dia Realizada</th>
                                    <th>M√©dia Diferen√ßa</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaDespesas">
                                <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CATEGORIAS DE RECEITA -->
    <div class="section-header">
        <i class="bi bi-pie-chart"></i>
        <h5>Receitas por Categoria</h5>
    </div>
    <div class="row mb-4">
        <!-- Gr√°fico de Pizza -->
        <div class="col-md-6 d-flex">
            <div class="card chart-card w-100">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-pie-chart-fill" style="color: var(--bpo-success);"></i>
                        Gr√°fico
                    </h6>
                    <canvas id="chartPizzaReceita"></canvas>
                </div>
            </div>
        </div>
        <!-- Tabela -->
        <div class="col-md-6 d-flex">
            <div class="card chart-card w-100">
                <div class="card-body d-flex flex-column">
                    <h6>
                        <i class="bi bi-table" style="color: var(--bpo-success);"></i>
                        Detalhamento
                    </h6>
                    <div class="table-responsive flex-grow-1" style="max-height: 450px; overflow-y: auto;">
                        <table class="table table-hover table-categorias">
                            <thead class="sticky-top">
                                <tr>
                                    <th>Natureza</th>
                                    <th>M√©dia Prevista</th>
                                    <th>M√©dia Realizada</th>
                                    <th>M√©dia Diferen√ßa</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaReceitas">
                                <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.table-categorias {
    margin-bottom: 0;
    font-size: 0.95rem;
}

.table-categorias thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.table-categorias thead th {
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    padding: 14px 12px;
    border: none;
    vertical-align: middle;
    text-align: center;
}

.table-categorias tbody tr {
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
}

.table-categorias tbody tr:hover {
    background-color: #f8f9ff;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.table-categorias tbody td {
    padding: 18px 12px;
    vertical-align: middle;
    border: none;
    text-align: center;
    font-weight: 500;
}

.table-categorias tbody td:first-child {
    font-weight: 600;
    color: #495057;
}

.table-categorias tbody td small {
    display: block;
    line-height: 1.5;
    font-weight: 500;
}

.table-responsive::-webkit-scrollbar {
    width: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Registrar plugin datalabels explicitamente
Chart.register(ChartDataLabels);

// Desabilitar datalabels por padr√£o (ser√° ativado apenas para PDF)
Chart.defaults.set('plugins.datalabels', {
    display: false
});

let chartReceita, chartDespesa, chartGeral, chartPizzaDespesa, chartPizzaReceita;

function formatMoney(val) {
    return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function atualizarDados() {
    const tipo_dre = document.getElementById('tipo_dre').value;
    const mes_inicio = document.getElementById('mes_inicio').value;
    const ano_inicio = document.getElementById('ano_inicio').value;
    const mes_fim = document.getElementById('mes_fim').value;
    const ano_fim = document.getElementById('ano_fim').value;

    {% if is_user_view %}
    const url = `/user/api/dados-bpo/{{ empresa_id }}?tipo_dre=${tipo_dre}&mes_inicio=${mes_inicio}&ano_inicio=${ano_inicio}&mes_fim=${mes_fim}&ano_fim=${ano_fim}`;
    {% else %}
    const url = `/admin/api/dados-bpo/{{ empresa_id }}?tipo_dre=${tipo_dre}&mes_inicio=${mes_inicio}&ano_inicio=${ano_inicio}&mes_fim=${mes_fim}&ano_fim=${ano_fim}`;
    {% endif %}

    fetch(url)
        .then(r => r.json())
        .then(data => {
            console.log('Dados recebidos da API:', data);
            console.log('totais_acumulados:', data.totais_acumulados);

            // Atualizar cards com porcentagens
            const tot = data.totais_acumulados;

            // Card Fluxo de Caixa
            const fc_rec = tot.fluxo_caixa.receita || 0;
            const fc_desp = tot.fluxo_caixa.despesa || 0;
            const fc_ger = tot.fluxo_caixa.geral || 0;
            const fc_perc_desp = fc_rec !== 0 ? (Math.abs(fc_desp) / fc_rec * 100).toFixed(2) : '0.00';
            const fc_perc_ger = fc_rec !== 0 ? (fc_ger / fc_rec * 100).toFixed(2) : '0.00';
            document.getElementById('card_fc_rec').textContent = formatMoney(fc_rec) + ' (100%)';
            document.getElementById('card_fc_desp').textContent = formatMoney(fc_desp) + ` (${fc_perc_desp}%)`;
            document.getElementById('card_fc_ger').textContent = formatMoney(fc_ger) + ` (${fc_perc_ger}%)`;

            // Card Real
            const real_rec = tot.real.receita || 0;
            const real_desp = tot.real.despesa || 0;
            const real_ger = tot.real.geral || 0;
            const real_perc_desp = real_rec !== 0 ? (Math.abs(real_desp) / real_rec * 100).toFixed(2) : '0.00';
            const real_perc_ger = real_rec !== 0 ? (real_ger / real_rec * 100).toFixed(2) : '0.00';
            document.getElementById('card_real_rec').textContent = formatMoney(real_rec) + ' (100%)';
            document.getElementById('card_real_desp').textContent = formatMoney(real_desp) + ` (${real_perc_desp}%)`;
            document.getElementById('card_real_ger').textContent = formatMoney(real_ger) + ` (${real_perc_ger}%)`;

            // Card Real + MP
            const mp_rec = tot.real_mp.receita || 0;
            const mp_desp = tot.real_mp.despesa || 0;
            const mp_ger = tot.real_mp.geral || 0;
            const mp_perc_desp = mp_rec !== 0 ? (Math.abs(mp_desp) / mp_rec * 100).toFixed(2) : '0.00';
            const mp_perc_ger = mp_rec !== 0 ? (mp_ger / mp_rec * 100).toFixed(2) : '0.00';
            document.getElementById('card_mp_rec').textContent = formatMoney(mp_rec) + ' (100%)';
            document.getElementById('card_mp_desp').textContent = formatMoney(mp_desp) + ` (${mp_perc_desp}%)`;
            document.getElementById('card_mp_ger').textContent = formatMoney(mp_ger) + ` (${mp_perc_ger}%)`;

            // Atualizar tabela do DRE selecionado com m√©dias
            const num_meses = data.num_meses || 1; // Evitar divis√£o por zero
            const tot_orc = data.totais_orcamento || {
                'fluxo_caixa': {'receita': 0, 'despesa': 0, 'geral': 0},
                'real': {'receita': 0, 'despesa': 0, 'geral': 0},
                'real_mp': {'receita': 0, 'despesa': 0, 'geral': 0}
            };
            const dre_sel = tot[tipo_dre];
            const dre_orc = tot_orc[tipo_dre] || {'receita': 0, 'despesa': 0, 'geral': 0};

            // Calcular m√©dias previstas (or√ßamento / num_meses)
            const media_prev_rec = (dre_orc.receita || 0) / num_meses;
            const media_prev_desp = (dre_orc.despesa || 0) / num_meses;
            const media_prev_res = (dre_orc.geral || 0) / num_meses;

            // Calcular m√©dias realizadas (realizado / num_meses)
            const media_real_rec = (dre_sel.receita || 0) / num_meses;
            const media_real_desp = (dre_sel.despesa || 0) / num_meses;
            const media_real_res = (dre_sel.geral || 0) / num_meses;

            // Calcular diferen√ßas
            const dif_rec = media_real_rec - media_prev_rec;
            const dif_desp = media_real_desp - media_prev_desp;
            const dif_res = media_real_res - media_prev_res;

            // Calcular porcentagens para M√©dia Prevista
            const tab_prev_perc_desp = media_prev_rec !== 0 ? (Math.abs(media_prev_desp) / media_prev_rec * 100).toFixed(2) : '0.00';
            const tab_prev_perc_res = media_prev_rec !== 0 ? (media_prev_res / media_prev_rec * 100).toFixed(2) : '0.00';

            // Calcular porcentagens para M√©dia Realizada
            const tab_real_perc_desp = media_real_rec !== 0 ? (Math.abs(media_real_desp) / media_real_rec * 100).toFixed(2) : '0.00';
            const tab_real_perc_res = media_real_rec !== 0 ? (media_real_res / media_real_rec * 100).toFixed(2) : '0.00';

            // Calcular porcentagens para Diferen√ßa (prevista / realizada)
            const tab_dif_perc_rec = media_real_rec !== 0 ? (media_prev_rec / media_real_rec * 100).toFixed(2) : '0.00';
            const tab_dif_perc_desp = media_real_desp !== 0 ? (media_prev_desp / media_real_desp * 100).toFixed(2) : '0.00';
            const tab_dif_perc_res = media_real_res !== 0 ? (media_prev_res / media_real_res * 100).toFixed(2) : '0.00';

            // Atualizar tabela com porcentagens
            // M√©dia Prevista
            document.getElementById('tab_rec_prev').textContent = formatMoney(media_prev_rec) + ' (100%)';
            document.getElementById('tab_desp_prev').textContent = formatMoney(media_prev_desp) + ` (${tab_prev_perc_desp}%)`;
            document.getElementById('tab_res_prev').textContent = formatMoney(media_prev_res) + ` (${tab_prev_perc_res}%)`;

            // M√©dia Realizada
            document.getElementById('tab_rec_real').textContent = formatMoney(media_real_rec) + ' (100%)';
            document.getElementById('tab_desp_real').textContent = formatMoney(media_real_desp) + ` (${tab_real_perc_desp}%)`;
            document.getElementById('tab_res_real').textContent = formatMoney(media_real_res) + ` (${tab_real_perc_res}%)`;

            // Diferen√ßa
            document.getElementById('tab_rec_dif').textContent = formatMoney(dif_rec) + ` (${tab_dif_perc_rec}%)`;
            document.getElementById('tab_desp_dif').textContent = formatMoney(dif_desp) + ` (${tab_dif_perc_desp}%)`;
            document.getElementById('tab_res_dif').textContent = formatMoney(dif_res) + ` (${tab_dif_perc_res}%)`;

            // Atualizar gr√°ficos
            atualizarGraficos(data.meses, data.receitas, data.despesas, data.gerais);

            // Atualizar categorias de despesa
            atualizarCategoriasDespesa(data.categorias_despesa, data.total_receita_orcado, data.num_meses);

            // Atualizar categorias de receita
            atualizarCategoriasReceita(data.categorias_receita, data.num_meses);

            // Mostrar bot√£o de exportar PDF ap√≥s todos os gr√°ficos estarem carregados
            setTimeout(() => {
                document.getElementById('btn-exportar-pdf').style.display = 'inline-block';
            }, 200);
        })
        .catch(error => {
            console.error('Erro ao carregar dados:', error);
            alert('Erro ao carregar dados do dashboard. Verifique o console para mais detalhes.');
        });
}

async function exportarDashboardPDF() {
    try {
        console.log('üìÑ Iniciando exporta√ß√£o de PDF...');

        // Esconder bot√£o durante exporta√ß√£o
        const btnExportar = document.getElementById('btn-exportar-pdf');
        const textoOriginal = btnExportar.innerHTML;
        btnExportar.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Gerando PDF...';
        btnExportar.disabled = true;

        // Importar jsPDF
        const { jsPDF } = window.jspdf;

        // Criar PDF em modo paisagem (landscape)
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });

        // Dimens√µes da p√°gina A4 landscape
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 15;

        // Informa√ß√µes do cabe√ßalho
        const empresaNome = '{{ empresa.nome }}';
        const tipoDre = document.getElementById('tipo_dre').options[document.getElementById('tipo_dre').selectedIndex].text;
        const mesInicio = document.getElementById('mes_inicio').value;
        const anoInicio = document.getElementById('ano_inicio').value;
        const mesFim = document.getElementById('mes_fim').value;
        const anoFim = document.getElementById('ano_fim').value;
        const periodo = `${mesInicio}/${anoInicio} at√© ${mesFim}/${anoFim}`;
        const dataGeracao = new Date().toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        // Obter todos os canvas de gr√°ficos vis√≠veis
        const canvasElements = [
            document.getElementById('chartReceita'),
            document.getElementById('chartDespesa'),
            document.getElementById('chartGeral'),
            document.getElementById('chartPizzaDespesa'),
            document.getElementById('chartPizzaReceita')
        ].filter(canvas => canvas !== null);

        console.log(`üìä Encontrados ${canvasElements.length} gr√°ficos para exportar`);

        if (canvasElements.length === 0) {
            alert('Nenhum gr√°fico dispon√≠vel para exportar.');
            btnExportar.innerHTML = textoOriginal;
            btnExportar.disabled = false;
            return;
        }

        let isFirstPage = true;

        // Processar cada canvas
        for (let i = 0; i < canvasElements.length; i++) {
            const canvas = canvasElements[i];

            console.log(`üìà Processando gr√°fico ${i + 1}/${canvasElements.length}...`);

            // Adicionar nova p√°gina se n√£o for a primeira
            if (!isFirstPage) {
                pdf.addPage();
            }
            isFirstPage = false;

            // === CABE√áALHO ===
            // Logo (se existir)
            const logoImg = document.querySelector('.navbar-brand img');
            if (logoImg) {
                try {
                    const logoCanvas = await html2canvas(logoImg, {
                        scale: 2,
                        backgroundColor: null
                    });
                    const logoData = logoCanvas.toDataURL('image/png');
                    pdf.addImage(logoData, 'PNG', margin, margin, 30, 10);
                } catch (err) {
                    console.warn('‚ö†Ô∏è Erro ao capturar logo:', err);
                }
            }

            // T√≠tulo do relat√≥rio
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Dashboard BPO', pageWidth / 2, margin + 5, { align: 'center' });

            // Informa√ß√µes do filtro
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Empresa: ${empresaNome}`, margin + 35, margin + 3);
            pdf.text(`Tipo DRE: ${tipoDre}`, margin + 35, margin + 7);
            pdf.text(`Per√≠odo: ${periodo}`, margin + 35, margin + 11);

            // === GR√ÅFICO ===
            try {
                // Encontrar a inst√¢ncia do Chart.js associada a este canvas
                const chartId = canvas.id;
                let chartInstance = null;

                // Os gr√°ficos BPO s√£o armazenados em vari√°veis globais
                if (chartId === 'chartReceita') chartInstance = chartReceita;
                else if (chartId === 'chartDespesa') chartInstance = chartDespesa;
                else if (chartId === 'chartGeral') chartInstance = chartGeral;
                else if (chartId === 'chartPizzaDespesa') chartInstance = chartPizzaDespesa;
                else if (chartId === 'chartPizzaReceita') chartInstance = chartPizzaReceita;

                console.log(`üìä Processando gr√°fico ID: ${chartId}`);
                console.log(`   Inst√¢ncia encontrada:`, !!chartInstance);

                if (chartInstance) {
                    console.log(`üé® Ativando labels para gr√°fico: ${chartId}`);
                    console.log(`   Tipo de gr√°fico:`, chartInstance.config.type);

                    // Ativar datalabels temporariamente com configura√ß√£o adequada
                    const chartType = chartInstance.config.type;

                    // Garantir que o objeto plugins existe
                    if (!chartInstance.options.plugins) {
                        chartInstance.options.plugins = {};
                    }

                    chartInstance.options.plugins.datalabels = {
                        display: true,
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: chartType === 'pie' ? 11 : 10
                        },
                        formatter: (value, context) => {
                            if (chartType === 'pie') {
                                // Para pizza, mostrar percentual
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return percent + '%';
                            } else {
                                // Para barras, mostrar valor em milhares
                                const absValue = Math.abs(value);
                                if (absValue >= 1000) {
                                    return 'R$ ' + (absValue / 1000).toFixed(0) + 'k';
                                } else {
                                    return 'R$ ' + absValue.toFixed(0);
                                }
                            }
                        },
                        anchor: chartType === 'pie' ? 'center' : 'end',
                        align: chartType === 'pie' ? 'center' : 'end',
                        offset: chartType === 'pie' ? 0 : -2
                    };

                    console.log(`   Configura√ß√£o datalabels aplicada:`, chartInstance.options.plugins.datalabels);

                    // Atualizar gr√°fico FOR√áANDO re-render
                    chartInstance.update(); // SEM 'none' para for√ßar re-render completo
                    console.log(`   Update() chamado`);

                    // Aguardar mais tempo para garantir que renderizou
                    await new Promise(resolve => setTimeout(resolve, 500));
                    console.log(`   Aguardou 500ms`);
                } else {
                    console.warn(`‚ö†Ô∏è Inst√¢ncia do gr√°fico ${chartId} N√ÉO encontrada!`);
                }

                // Capturar o canvas do gr√°fico
                console.log(`üì∏ Capturando canvas...`);
                const chartCanvas = await html2canvas(canvas, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });

                const chartData = chartCanvas.toDataURL('image/png');
                console.log(`   Canvas capturado`);

                // Restaurar estado original (desabilitar labels)
                if (chartInstance) {
                    console.log(`üîÑ Desativando labels para gr√°fico: ${chartId}`);
                    chartInstance.options.plugins.datalabels = { display: false };
                    chartInstance.update();
                    console.log(`   Labels desativados`);
                }

                // Dimens√µes do gr√°fico (deixar espa√ßo para cabe√ßalho e rodap√©)
                const chartHeight = pageHeight - margin * 3 - 20;
                const chartWidth = pageWidth - margin * 2;
                const chartY = margin + 20;

                pdf.addImage(chartData, 'PNG', margin, chartY, chartWidth, chartHeight);

                console.log(`‚úÖ Gr√°fico ${i + 1} adicionado ao PDF`);
            } catch (err) {
                console.error(`‚ùå Erro ao capturar gr√°fico ${i + 1}:`, err);
                pdf.setFontSize(12);
                pdf.setTextColor(255, 0, 0);
                pdf.text(`Erro ao carregar gr√°fico ${i + 1}`, pageWidth / 2, pageHeight / 2, { align: 'center' });
                pdf.setTextColor(0, 0, 0);
            }

            // === RODAP√â ===
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'italic');
            pdf.setTextColor(128, 128, 128);
            pdf.text(`Gerado em: ${dataGeracao}`, margin, pageHeight - 10);
            pdf.text(`P√°gina ${i + 1} de ${canvasElements.length}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
            pdf.setTextColor(0, 0, 0);
        }

        // Salvar PDF
        const nomeArquivo = `Dashboard_BPO_${empresaNome.replace(/[^a-zA-Z0-9]/g, '_')}_${mesInicio}-${anoInicio}_ate_${mesFim}-${anoFim}_${new Date().getTime()}.pdf`;
        pdf.save(nomeArquivo);

        console.log(`‚úÖ PDF gerado com sucesso: ${nomeArquivo}`);

        // Restaurar bot√£o
        btnExportar.innerHTML = textoOriginal;
        btnExportar.disabled = false;

    } catch (error) {
        console.error('üí• ERRO ao gerar PDF:', error);
        console.error('Stack trace:', error.stack);
        alert('Erro ao gerar PDF. Verifique o console para mais detalhes.');

        // Restaurar bot√£o
        const btnExportar = document.getElementById('btn-exportar-pdf');
        btnExportar.innerHTML = '<i class="bi bi-file-pdf-fill me-2"></i>Baixar PDF';
        btnExportar.disabled = false;
    }
}

function atualizarGraficos(labels, receitas, despesas, gerais) {
    // Receita
    if (chartReceita) chartReceita.destroy();
    chartReceita = new Chart(document.getElementById('chartReceita'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Receita',
                data: receitas,
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            plugins: {legend: {display: false}}
        }
    });

    // Despesa
    if (chartDespesa) chartDespesa.destroy();
    chartDespesa = new Chart(document.getElementById('chartDespesa'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Despesa',
                data: despesas,
                backgroundColor: '#dc3545'
            }]
        },
        options: {
            responsive: true,
            plugins: {legend: {display: false}}
        }
    });

    // Geral
    if (chartGeral) chartGeral.destroy();
    chartGeral = new Chart(document.getElementById('chartGeral'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Geral',
                data: gerais,
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            plugins: {legend: {display: false}}
        }
    });
}

function atualizarCategoriasDespesa(categorias, totalReceitaOrcado, numMeses) {
    if (!categorias || Object.keys(categorias).length === 0) {
        document.getElementById('tabelaDespesas').innerHTML = '<tr><td colspan="4" class="text-center">Sem dados</td></tr>';
        return;
    }

    // Preparar dados para o gr√°fico de pizza
    const labels = [];
    const valores = [];
    const cores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];
    let totalRealizado = 0;

    // Calcular total realizado
    for (const codigo in categorias) {
        totalRealizado += categorias[codigo].realizado;
    }

    // Ordenar por c√≥digo
    const codigosOrdenados = Object.keys(categorias).sort();

    // Preparar dados do gr√°fico
    codigosOrdenados.forEach((codigo, index) => {
        const cat = categorias[codigo];
        labels.push(cat.nome);
        valores.push(Math.abs(cat.realizado)); // Usar valor absoluto para o gr√°fico
    });

    // Atualizar gr√°fico de pizza
    if (chartPizzaDespesa) chartPizzaDespesa.destroy();
    chartPizzaDespesa = new Chart(document.getElementById('chartPizzaDespesa'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: cores
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        generateLabels: function(chart) {
                            const data = chart.data;
                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                            return data.labels.map((label, i) => {
                                const value = data.datasets[0].data[i];
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return {
                                    text: `${label}: ${formatMoney(value)} (${percent}%)`,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${formatMoney(value)} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });

    // Atualizar tabela
    let htmlTabela = '';
    codigosOrdenados.forEach(codigo => {
        const cat = categorias[codigo];
        const orcado = cat.orcado;
        const realizado = cat.realizado;
        const diferenca = cat.diferenca;

        // Calcular porcentagens
        // M√©dia Prevista: (or√ßado / total receita or√ßado) * 100
        const percPrev = totalReceitaOrcado !== 0 ? (Math.abs(orcado) / totalReceitaOrcado * 100).toFixed(2) : '0.00';

        // M√©dia Realizada: (realizado / or√ßado) * 100
        const percReal = orcado !== 0 ? (realizado / orcado * 100).toFixed(2) : '0.00';

        // M√©dia Diferen√ßa: ((or√ßado - realizado) / or√ßado) * 100
        const percDif = orcado !== 0 ? ((orcado - realizado) / orcado * 100).toFixed(2) : '0.00';

        htmlTabela += `
            <tr>
                <td><small>${cat.nome}</small></td>
                <td><small>${formatMoney(orcado)} (${percPrev}%)</small></td>
                <td><small>${formatMoney(realizado)} (${percReal}%)</small></td>
                <td><small>${formatMoney(diferenca)} (${percDif}%)</small></td>
            </tr>
        `;
    });

    document.getElementById('tabelaDespesas').innerHTML = htmlTabela;
}

function atualizarCategoriasReceita(categorias, numMeses) {
    if (!categorias || Object.keys(categorias).length === 0) {
        document.getElementById('tabelaReceitas').innerHTML = '<tr><td colspan="4" class="text-center">Sem dados</td></tr>';
        return;
    }

    // Preparar dados para o gr√°fico de pizza
    const labels = [];
    const valores = [];
    const cores = ['#4BC0C0', '#36A2EB', '#FFCE56', '#FF6384', '#9966FF', '#FF9F40', '#C9CBCF', '#8DD1E1'];
    let totalRealizado = 0;
    let totalOrcado = 0;

    // Calcular totais
    for (const codigo in categorias) {
        totalRealizado += categorias[codigo].realizado;
        totalOrcado += categorias[codigo].orcado;
    }

    // Ordenar por c√≥digo
    const codigosOrdenados = Object.keys(categorias).sort();

    // Preparar dados do gr√°fico
    codigosOrdenados.forEach((codigo, index) => {
        const cat = categorias[codigo];
        labels.push(cat.nome);
        valores.push(Math.abs(cat.realizado)); // Usar valor absoluto para o gr√°fico
    });

    // Atualizar gr√°fico de pizza
    if (chartPizzaReceita) chartPizzaReceita.destroy();
    chartPizzaReceita = new Chart(document.getElementById('chartPizzaReceita'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: cores
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        generateLabels: function(chart) {
                            const data = chart.data;
                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                            return data.labels.map((label, i) => {
                                const value = data.datasets[0].data[i];
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return {
                                    text: `${label}: ${formatMoney(value)} (${percent}%)`,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${formatMoney(value)} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });

    // Atualizar tabela
    let htmlTabela = '';
    codigosOrdenados.forEach(codigo => {
        const cat = categorias[codigo];
        const orcado = cat.orcado;
        const realizado = cat.realizado;
        const diferenca = cat.diferenca;

        // Calcular porcentagens
        // M√©dia Prevista: (or√ßado / total de todos or√ßados) * 100 (como no gr√°fico)
        const percPrev = totalOrcado !== 0 ? (Math.abs(orcado) / totalOrcado * 100).toFixed(2) : '0.00';

        // M√©dia Realizada: (realizado / or√ßado) * 100
        const percReal = orcado !== 0 ? (realizado / orcado * 100).toFixed(2) : '0.00';

        // M√©dia Diferen√ßa: (diferen√ßa / previsto) * 100
        const percDif = orcado !== 0 ? (diferenca / orcado * 100).toFixed(2) : '0.00';

        htmlTabela += `
            <tr>
                <td><small>${cat.nome}</small></td>
                <td><small>${formatMoney(orcado)} (${percPrev}%)</small></td>
                <td><small>${formatMoney(realizado)} (${percReal}%)</small></td>
                <td><small>${formatMoney(diferenca)} (${percDif}%)</small></td>
            </tr>
        `;
    });

    document.getElementById('tabelaReceitas').innerHTML = htmlTabela;
}

// Carregar ao iniciar
atualizarDados();
</script>

{% endblock %}
