{% extends "user/base.html" %}

{% block header_title %}Dashboard BPO - {{ empresa.nome }}{% endblock %}
{% block header_subtitle %}Visualização de dados mensais{% endblock %}

{% block content %}

<style>
:root {
    --bpo-primary: #6366f1;
    --bpo-success: #10b981;
    --bpo-danger: #ef4444;
    --bpo-warning: #f59e0b;
    --bpo-info: #3b82f6;
    --bpo-purple: #8b5cf6;
}

.table-categorias thead th {
    color: #000 !important;
    background-color: #f8f9fa;
}

/* Banner */
.bpo-banner {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-left: 4px solid var(--bpo-primary);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
}

.bpo-banner h5 {
    color: #1e3a8a;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.bpo-banner p {
    color: #1e40af;
    margin-bottom: 0;
}

/* Cards de filtro */
.filter-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.filter-card:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.filter-card h5 {
    color: #1e293b;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Cards DRE */
.dre-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border: 1px solid #e2e8f0;
    position: relative;
    overflow: hidden;
    height: 100%;
}

.dre-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.dre-card.fluxo-caixa::before {
    background: linear-gradient(90deg, var(--bpo-primary), var(--bpo-info));
}

.dre-card.real::before {
    background: linear-gradient(90deg, var(--bpo-success), #059669);
}

.dre-card.real-mp::before {
    background: linear-gradient(90deg, var(--bpo-purple), #7c3aed);
}

.dre-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}

.dre-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.dre-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.dre-card.fluxo-caixa .dre-icon {
    background: linear-gradient(135deg, var(--bpo-primary), var(--bpo-info));
}

.dre-card.real .dre-icon {
    background: linear-gradient(135deg, var(--bpo-success), #059669);
}

.dre-card.real-mp .dre-icon {
    background: linear-gradient(135deg, var(--bpo-purple), #7c3aed);
}

.dre-card h6 {
    color: #1e293b;
    font-weight: 700;
    font-size: 1.1rem;
    margin: 0;
}

.dre-metric {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f5f9;
    color: #64748b;
    font-size: 0.9rem;
}

.dre-metric:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.dre-metric strong {
    color: #1e293b;
    font-weight: 600;
}

/* Títulos de seção */
.section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    margin-top: 2rem;
}

.section-header h5 {
    color: #1e293b;
    font-weight: 700;
    font-size: 1.5rem;
    margin: 0;
}

.section-header i {
    color: var(--bpo-primary);
    font-size: 1.75rem;
}

/* Cards de gráficos */
.chart-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    overflow: hidden;
}

.chart-card:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.chart-card .card-body h6 {
    color: #1e293b;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Aumentar tamanho dos gráficos de pizza */
#chartPizzaDespesa,
#chartPizzaReceita {
    max-height: 400px !important;
    height: 400px !important;
}

/* Tabela estilizada */
.styled-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.styled-table thead th {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    color: #1e293b;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    padding: 1rem;
    border: none;
}

.styled-table tbody th {
    background: #f8fafc;
    color: #1e293b;
    font-weight: 600;
}

.styled-table tbody td {
    padding: 0.875rem 1rem;
    color: #64748b;
}

.styled-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
}

.styled-table tbody tr:last-child {
    border-bottom: none;
}

.styled-table tbody tr:hover {
    background: #f8fafc;
}

/* Botão de filtrar */
.btn-filter {
    background: linear-gradient(135deg, var(--bpo-primary), var(--bpo-info));
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.625rem 1.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.btn-filter:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    background: linear-gradient(135deg, #4f46e5, #2563eb);
    color: white;
}

.btn-purple {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.625rem 1.5rem;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.btn-purple:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    color: white;
}

.btn-purple:disabled {
    opacity: 0.7;
    transform: none;
}

.badge-novo {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    font-size: 0.6rem;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 8px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
    animation: pulseBadge 2s ease-in-out infinite;
}

@keyframes pulseBadge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Form controls */
.form-label {
    color: #475569;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.form-select, .form-control {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.625rem 0.875rem;
    transition: all 0.2s ease;
}

.form-select:focus, .form-control:focus {
    border-color: var(--bpo-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* ========== CSS PARA IMPRESSÃO/PDF ========== */
@media print {
    /* Esconder sidebar e header */
    .sidebar,
    .main-header,
    .bpo-banner,
    .filter-card,
    .btn,
    button {
        display: none !important;
    }

    /* Remover margens e ajustar layout */
    html, body {
        margin: 0;
        padding: 0;
        background: white;
        height: auto !important;
        overflow: visible !important;
    }

    .main-wrapper {
        margin-left: 0 !important;
        width: 100% !important;
        height: auto !important;
        display: block !important;
    }

    .main-content {
        padding: 10mm !important;
        overflow: visible !important;
        height: auto !important;
        max-height: none !important;
    }

    /* Ajustar cards para impressão - COMPACTAR */
    .card {
        page-break-inside: avoid !important;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
        margin-bottom: 0.3rem !important;
        padding: 0 !important;
    }

    .card-body {
        padding: 0.5rem !important;
        page-break-inside: avoid !important;
    }

    .card-header {
        padding: 0.4rem 0.5rem !important;
        font-size: 10pt !important;
    }

    /* Reduzir tamanho dos gráficos - um pouco maior para legibilidade */
    canvas {
        max-width: 100% !important;
        max-height: 250px !important;
        height: auto !important;
        page-break-inside: avoid !important;
    }

    /* Gráficos de pizza menores no PDF */
    #chartPizzaDespesa,
    #chartPizzaReceita {
        max-height: 280px !important;
        max-width: 400px !important;
        height: 280px !important;
        width: 400px !important;
        margin: 0 auto !important;
        display: block !important;
    }

    /* Container dos gráficos de pizza - centralizar */
    .chart-card .card-body {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        text-align: center !important;
    }

    /* Container de gráficos - compacto */
    .chart-container {
        page-break-inside: avoid !important;
        margin-bottom: 0.3rem !important;
        padding: 0.3rem !important;
        max-height: 270px !important;
    }

    /* Reduzir espaçamento das rows */
    .row {
        margin-bottom: 0.3rem !important;
        page-break-inside: avoid;
    }

    /* Colunas mais compactas */
    .col, [class*="col-"] {
        padding-left: 0.25rem !important;
        padding-right: 0.25rem !important;
    }

    /* Seções mais compactas */
    .section-header {
        page-break-after: avoid;
        margin-top: 0.3rem !important;
        margin-bottom: 0.3rem !important;
        font-size: 11pt !important;
        padding: 0.2rem 0 !important;
    }

    /* Ajustar tabelas */
    table {
        page-break-inside: auto;
        font-size: 9pt;
    }

    table tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }

    thead {
        display: table-header-group;
    }

    tfoot {
        display: table-footer-group;
    }

    /* Remover scroll das tabelas de detalhamento no PDF */
    .table-responsive {
        max-height: none !important;
        overflow: visible !important;
    }

    /* Título do relatório - compacto */
    .print-title {
        display: block !important;
        text-align: center;
        font-size: 14pt;
        font-weight: bold;
        margin-bottom: 0.5rem !important;
        color: #333;
        page-break-after: avoid;
    }

    /* Margens da página - reduzidas */
    @page {
        margin: 10mm;
        size: A4 portrait;
    }

    /* Reduzir fontes gerais */
    body, p, span, div {
        font-size: 9pt !important;
        line-height: 1.2 !important;
    }

    h1, h2, h3, h4, h5, h6 {
        margin-top: 0.3rem !important;
        margin-bottom: 0.3rem !important;
        line-height: 1.2 !important;
    }

    h5 {
        font-size: 11pt !important;
    }

    /* Títulos de cards menores */
    .card-title {
        font-size: 10pt !important;
        margin-bottom: 0.3rem !important;
    }

    /* Badges e labels menores */
    .badge {
        font-size: 8pt !important;
        padding: 0.2rem 0.4rem !important;
    }

    /* Remover padding extra */
    .container-fluid {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }

    /* Remover interatividade de gráficos */
    .chart-container {
        pointer-events: none;
    }
}

/* Título visível apenas na impressão */
.print-title {
    display: none;
}
</style>

<!-- Título visível apenas na impressão -->
<div class="print-title">
    Relatório BPO - {{ empresa.nome }}<br>
    <small id="print-periodo" style="font-size: 12pt; font-weight: normal;"></small>
</div>

<!-- Banner BPO -->
<div class="bpo-banner">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h5>
                <i class="bi bi-graph-up-arrow me-2"></i>
                Dashboard BPO - <strong>{{ empresa.nome }}</strong>
            </h5>
            <p class="small">
                Análise detalhada de receitas, despesas e resultados mensais
            </p>
        </div>
        {% if is_user_view %}
        <a href="{{ url_for('user.user_dashboard') }}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i> Voltar ao Dashboard
        </a>
        {% else %}
        <a href="{{ url_for('admin.gerenciar_empresas') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Voltar para Empresas
        </a>
        {% endif %}
    </div>
</div>

<div class="container-fluid px-4">
    <!-- FILTROS -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <h5>
                <i class="bi bi-funnel"></i>
                Filtros de Período
            </h5>
            <div class="row g-3">
                <div class="col-12 col-md-4 col-lg-3">
                    <label class="form-label">Tipo de DRE</label>
                    <select id="tipo_dre" class="form-select">
                        <option value="fluxo_caixa">Fluxo de Caixa</option>
                        <option value="real">Real</option>
                        <option value="real_mp">Real + Custo MP</option>
                    </select>
                </div>
                <div class="col-12 col-md-4 col-lg-3">
                    <label class="form-label">Período Inicial</label>
                    <div class="input-group">
                        <input type="text" id="periodo_inicio_display" class="form-control" placeholder="Selecione..." readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="abrirCalendario('inicio')">
                            <i class="bi bi-calendar3"></i>
                        </button>
                    </div>
                    <input type="hidden" id="mes_inicio" value="1">
                    <input type="hidden" id="ano_inicio" value="2025">
                </div>
                <div class="col-12 col-md-4 col-lg-3">
                    <label class="form-label">Período Final</label>
                    <div class="input-group">
                        <input type="text" id="periodo_fim_display" class="form-control" placeholder="Selecione..." readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="abrirCalendario('fim')">
                            <i class="bi bi-calendar3"></i>
                        </button>
                    </div>
                    <input type="hidden" id="mes_fim" value="12">
                    <input type="hidden" id="ano_fim" value="2025">
                </div>
                <div class="col-6 col-md-6 col-lg-auto d-flex align-items-end">
                    <button class="btn btn-filter px-4" onclick="atualizarDados()">
                        <i class="bi bi-search me-2"></i>Filtrar
                    </button>
                </div>
                <div class="col-6 col-md-6 col-lg-auto d-flex align-items-end">
                    <button class="btn btn-danger px-4" onclick="gerarPDF()" title="Relatório de Gráficos">
                        <i class="bi bi-file-pdf me-2"></i>Relatório de Gráficos
                    </button>
                </div>
                <div class="col-6 col-md-6 col-lg-auto d-flex align-items-end">
                    <button id="btnRelatorioIA" class="btn btn-purple px-4 position-relative" onclick="gerarRelatorioIA_BPO()" title="Analisar com a IA">
                        <i class="bi bi-robot me-2"></i>Analisar com a IA
                        <span class="badge-novo">Novo</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- RESULTADO GERAL -->
    <div class="section-header">
        <i class="bi bi-clipboard-data"></i>
        <h5>Resultado Geral</h5>
    </div>

    <!-- 3 CARDS DOS DREs -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="dre-card fluxo-caixa">
                <div class="dre-card-header">
                    <div class="dre-icon">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <h6>Resultado por Fluxo de Caixa</h6>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-up-circle me-1"></i>Receita:</span>
                    <strong id="card_fc_rec">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-down-circle me-1"></i>Despesa:</span>
                    <strong id="card_fc_desp">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-graph-up me-1"></i>Resultado:</span>
                    <strong id="card_fc_ger">R$ 0,00</strong>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dre-card real">
                <div class="dre-card-header">
                    <div class="dre-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <h6>Resultado Real</h6>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-up-circle me-1"></i>Receita:</span>
                    <strong id="card_real_rec">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-down-circle me-1"></i>Despesa:</span>
                    <strong id="card_real_desp">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-graph-up me-1"></i>Resultado:</span>
                    <strong id="card_real_ger">R$ 0,00</strong>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dre-card real-mp">
                <div class="dre-card-header">
                    <div class="dre-icon">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <h6>Resultado Real + Custo MP</h6>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-up-circle me-1"></i>Receita:</span>
                    <strong id="card_mp_rec">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-arrow-down-circle me-1"></i>Despesa:</span>
                    <strong id="card_mp_desp">R$ 0,00</strong>
                </div>
                <div class="dre-metric">
                    <span><i class="bi bi-graph-up me-1"></i>Resultado:</span>
                    <strong id="card_mp_ger">R$ 0,00</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- TABELA DO DRE SELECIONADO -->
    <div class="table-responsive mb-4">
        <table class="table styled-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Média Prevista</th>
                    <th>Média Realizada</th>
                    <th>Diferença</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Total Receitas</th>
                    <td id="tab_rec_prev">R$ 0,00</td>
                    <td id="tab_rec_real">R$ 0,00</td>
                    <td id="tab_rec_dif">R$ 0,00</td>
                </tr>
                <tr>
                    <th>Total Despesas</th>
                    <td id="tab_desp_prev">R$ 0,00</td>
                    <td id="tab_desp_real">R$ 0,00</td>
                    <td id="tab_desp_dif">R$ 0,00</td>
                </tr>
                <tr>
                    <th>Total Resultado</th>
                    <td id="tab_res_prev">R$ 0,00</td>
                    <td id="tab_res_real">R$ 0,00</td>
                    <td id="tab_res_dif">R$ 0,00</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- GRÁFICOS -->
    <div class="section-header">
        <i class="bi bi-bar-chart-line"></i>
        <h5>Evolução Mensal</h5>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card chart-card">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-arrow-up-circle-fill" style="color: var(--bpo-success);"></i>
                        Receitas
                    </h6>
                    <canvas id="chartReceita"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 mb-4">
            <div class="card chart-card">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-arrow-down-circle-fill" style="color: var(--bpo-danger);"></i>
                        Despesas
                    </h6>
                    <canvas id="chartDespesa"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 mb-4">
            <div class="card chart-card">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-graph-up-arrow" style="color: var(--bpo-primary);"></i>
                        Resultados
                    </h6>
                    <canvas id="chartGeral"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- CATEGORIAS DE DESPESA -->
    <div class="section-header">
        <i class="bi bi-pie-chart"></i>
        <h5>Despesas por Categorias</h5>
    </div>
    <div class="row mb-4">
        <!-- Gráfico de Pizza -->
        <div class="col-md-6 d-flex">
            <div class="card chart-card w-100">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-pie-chart-fill" style="color: var(--bpo-danger);"></i>
                        Gráfico
                    </h6>
                    <canvas id="chartPizzaDespesa"></canvas>
                </div>
            </div>
        </div>
        <!-- Tabela -->
        <div class="col-md-6 d-flex">
            <div class="card chart-card w-100">
                <div class="card-body d-flex flex-column">
                    <h6>
                        <i class="bi bi-table" style="color: var(--bpo-danger);"></i>
                        Detalhamento
                    </h6>
                    <div class="table-responsive flex-grow-1" style="max-height: 450px; overflow-y: auto;">
                        <table class="table table-hover table-categorias">
                            <thead class="sticky-top">
                                <tr>
                                    <th>Natureza</th>
                                    <th>Média Prevista</th>
                                    <th>Média Realizada</th>
                                    <th>Média Diferença</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaDespesas">
                                <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CATEGORIAS DE RECEITA -->
    <div class="section-header">
        <i class="bi bi-pie-chart"></i>
        <h5>Receitas por Categoria</h5>
    </div>
    <div class="row mb-4">
        <!-- Gráfico de Pizza -->
        <div class="col-md-6 d-flex">
            <div class="card chart-card w-100">
                <div class="card-body">
                    <h6>
                        <i class="bi bi-pie-chart-fill" style="color: var(--bpo-success);"></i>
                        Gráfico
                    </h6>
                    <canvas id="chartPizzaReceita"></canvas>
                </div>
            </div>
        </div>
        <!-- Tabela -->
        <div class="col-md-6 d-flex">
            <div class="card chart-card w-100">
                <div class="card-body d-flex flex-column">
                    <h6>
                        <i class="bi bi-table" style="color: var(--bpo-success);"></i>
                        Detalhamento
                    </h6>
                    <div class="table-responsive flex-grow-1" style="max-height: 450px; overflow-y: auto;">
                        <table class="table table-hover table-categorias">
                            <thead class="sticky-top">
                                <tr>
                                    <th>Natureza</th>
                                    <th>Média Prevista</th>
                                    <th>Média Realizada</th>
                                    <th>Média Diferença</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaReceitas">
                                <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.table-categorias {
    margin-bottom: 0;
    font-size: 0.95rem;
}

.table-categorias thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.table-categorias thead th {
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    padding: 14px 12px;
    border: none;
    vertical-align: middle;
    text-align: center;
}

.table-categorias tbody tr {
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
}

.table-categorias tbody tr:hover {
    background-color: #f8f9ff;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.table-categorias tbody td {
    padding: 18px 12px;
    vertical-align: middle;
    border: none;
    text-align: center;
    font-weight: 500;
}

.table-categorias tbody td:first-child {
    font-weight: 600;
    color: #495057;
}

.table-categorias tbody td small {
    display: block;
    line-height: 1.5;
    font-weight: 500;
}

.table-responsive::-webkit-scrollbar {
    width: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
// Registrar o plugin datalabels
Chart.register(ChartDataLabels);

// Variável para controlar se está em modo de impressão (mostrar valores nas barras)
let modoImpressao = false;

let chartReceita, chartDespesa, chartGeral, chartPizzaDespesa, chartPizzaReceita;

function formatMoney(val) {
    return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

let dadosBPOAtuais = null;  // Armazena dados atuais para relatório IA

function atualizarDados() {
    const tipo_dre = document.getElementById('tipo_dre').value;
    const mes_inicio = document.getElementById('mes_inicio').value;
    const ano_inicio = document.getElementById('ano_inicio').value;
    const mes_fim = document.getElementById('mes_fim').value;
    const ano_fim = document.getElementById('ano_fim').value;

    {% if is_user_view %}
    const url = `/user/api/dados-bpo/{{ empresa_id }}?tipo_dre=${tipo_dre}&mes_inicio=${mes_inicio}&ano_inicio=${ano_inicio}&mes_fim=${mes_fim}&ano_fim=${ano_fim}`;
    {% else %}
    const url = `/admin/api/dados-bpo/{{ empresa_id }}?tipo_dre=${tipo_dre}&mes_inicio=${mes_inicio}&ano_inicio=${ano_inicio}&mes_fim=${mes_fim}&ano_fim=${ano_fim}`;
    {% endif %}

    fetch(url)
        .then(r => r.json())
        .then(data => {
            console.log('Dados recebidos da API:', data);
            console.log('totais_acumulados:', data.totais_acumulados);

            // Salvar dados globalmente para uso na geração de relatório IA
            dadosBPOAtuais = data;

            // Atualizar cards com porcentagens
            const tot = data.totais_acumulados;

            // Card Fluxo de Caixa
            const fc_rec = tot.fluxo_caixa.receita || 0;
            const fc_desp = tot.fluxo_caixa.despesa || 0;
            const fc_ger = tot.fluxo_caixa.geral || 0;
            const fc_perc_desp = fc_rec !== 0 ? (Math.abs(fc_desp) / fc_rec * 100).toFixed(2) : '0.00';
            const fc_perc_ger = fc_rec !== 0 ? (fc_ger / fc_rec * 100).toFixed(2) : '0.00';
            document.getElementById('card_fc_rec').textContent = formatMoney(fc_rec) + ' (100%)';
            document.getElementById('card_fc_desp').textContent = formatMoney(fc_desp) + ` (${fc_perc_desp}%)`;
            document.getElementById('card_fc_ger').textContent = formatMoney(fc_ger) + ` (${fc_perc_ger}%)`;

            // Card Real
            const real_rec = tot.real.receita || 0;
            const real_desp = tot.real.despesa || 0;
            const real_ger = tot.real.geral || 0;
            const real_perc_desp = real_rec !== 0 ? (Math.abs(real_desp) / real_rec * 100).toFixed(2) : '0.00';
            const real_perc_ger = real_rec !== 0 ? (real_ger / real_rec * 100).toFixed(2) : '0.00';
            document.getElementById('card_real_rec').textContent = formatMoney(real_rec) + ' (100%)';
            document.getElementById('card_real_desp').textContent = formatMoney(real_desp) + ` (${real_perc_desp}%)`;
            document.getElementById('card_real_ger').textContent = formatMoney(real_ger) + ` (${real_perc_ger}%)`;

            // Card Real + MP
            const mp_rec = tot.real_mp.receita || 0;
            const mp_desp = tot.real_mp.despesa || 0;
            const mp_ger = tot.real_mp.geral || 0;
            const mp_perc_desp = mp_rec !== 0 ? (Math.abs(mp_desp) / mp_rec * 100).toFixed(2) : '0.00';
            const mp_perc_ger = mp_rec !== 0 ? (mp_ger / mp_rec * 100).toFixed(2) : '0.00';
            document.getElementById('card_mp_rec').textContent = formatMoney(mp_rec) + ' (100%)';
            document.getElementById('card_mp_desp').textContent = formatMoney(mp_desp) + ` (${mp_perc_desp}%)`;
            document.getElementById('card_mp_ger').textContent = formatMoney(mp_ger) + ` (${mp_perc_ger}%)`;

            // Atualizar tabela do DRE selecionado com médias
            const num_meses = data.num_meses || 1; // Evitar divisão por zero
            const tot_orc = data.totais_orcamento || {
                'fluxo_caixa': {'receita': 0, 'despesa': 0, 'geral': 0},
                'real': {'receita': 0, 'despesa': 0, 'geral': 0},
                'real_mp': {'receita': 0, 'despesa': 0, 'geral': 0}
            };
            const dre_sel = tot[tipo_dre];
            const dre_orc = tot_orc[tipo_dre] || {'receita': 0, 'despesa': 0, 'geral': 0};

            // Calcular médias previstas (orçamento / num_meses)
            const media_prev_rec = (dre_orc.receita || 0) / num_meses;
            const media_prev_desp = (dre_orc.despesa || 0) / num_meses;
            const media_prev_res = (dre_orc.geral || 0) / num_meses;

            // Calcular médias realizadas (realizado / num_meses)
            const media_real_rec = (dre_sel.receita || 0) / num_meses;
            const media_real_desp = (dre_sel.despesa || 0) / num_meses;
            const media_real_res = (dre_sel.geral || 0) / num_meses;

            // Calcular diferenças
            const dif_rec = media_real_rec - media_prev_rec;
            const dif_desp = media_real_desp - media_prev_desp;
            const dif_res = media_real_res - media_prev_res;

            // Calcular porcentagens para Média Prevista
            const tab_prev_perc_desp = media_prev_rec !== 0 ? (Math.abs(media_prev_desp) / media_prev_rec * 100).toFixed(2) : '0.00';
            const tab_prev_perc_res = media_prev_rec !== 0 ? (media_prev_res / media_prev_rec * 100).toFixed(2) : '0.00';

            // Calcular porcentagens para Média Realizada
            const tab_real_perc_desp = media_real_rec !== 0 ? (Math.abs(media_real_desp) / media_real_rec * 100).toFixed(2) : '0.00';
            const tab_real_perc_res = media_real_rec !== 0 ? (media_real_res / media_real_rec * 100).toFixed(2) : '0.00';

            // Calcular porcentagens para Diferença (prevista / realizada)
            const tab_dif_perc_rec = media_real_rec !== 0 ? (media_prev_rec / media_real_rec * 100).toFixed(2) : '0.00';
            const tab_dif_perc_desp = media_real_desp !== 0 ? (media_prev_desp / media_real_desp * 100).toFixed(2) : '0.00';
            const tab_dif_perc_res = media_real_res !== 0 ? (media_prev_res / media_real_res * 100).toFixed(2) : '0.00';

            // Atualizar tabela com porcentagens
            // Média Prevista
            document.getElementById('tab_rec_prev').textContent = formatMoney(media_prev_rec) + ' (100%)';
            document.getElementById('tab_desp_prev').textContent = formatMoney(media_prev_desp) + ` (${tab_prev_perc_desp}%)`;
            document.getElementById('tab_res_prev').textContent = formatMoney(media_prev_res) + ` (${tab_prev_perc_res}%)`;

            // Média Realizada
            document.getElementById('tab_rec_real').textContent = formatMoney(media_real_rec) + ' (100%)';
            document.getElementById('tab_desp_real').textContent = formatMoney(media_real_desp) + ` (${tab_real_perc_desp}%)`;
            document.getElementById('tab_res_real').textContent = formatMoney(media_real_res) + ` (${tab_real_perc_res}%)`;

            // Diferença
            document.getElementById('tab_rec_dif').textContent = formatMoney(dif_rec) + ` (${tab_dif_perc_rec}%)`;

            // Para Despesa e Resultado: valor em R$ + diferença percentual (% Realizada - % Prevista)
            const dif_perc_desp = (parseFloat(tab_real_perc_desp) - parseFloat(tab_prev_perc_desp)).toFixed(2);
            const dif_perc_res = (parseFloat(tab_real_perc_res) - parseFloat(tab_prev_perc_res)).toFixed(2);

            document.getElementById('tab_desp_dif').textContent = formatMoney(dif_desp) + ` (${dif_perc_desp > 0 ? '+' : ''}${dif_perc_desp}%)`;
            document.getElementById('tab_res_dif').textContent = formatMoney(dif_res) + ` (${dif_perc_res > 0 ? '+' : ''}${dif_perc_res}%)`;

            // Atualizar gráficos
            atualizarGraficos(data.meses, data.receitas, data.despesas, data.gerais);

            // Atualizar categorias de despesa (passar média da receita prevista e realizada)
            atualizarCategoriasDespesa(data.categorias_despesa, media_prev_rec, media_real_rec, data.num_meses);

            // Atualizar categorias de receita
            atualizarCategoriasReceita(data.categorias_receita, media_prev_rec, media_real_rec, data.num_meses);
        })
        .catch(error => {
            console.error('Erro ao carregar dados:', error);
            alert('Erro ao carregar dados do dashboard. Verifique o console para mais detalhes.');
        });
}

function atualizarGraficos(labels, receitas, despesas, gerais) {
    // Salvar dados para uso na impressão
    dadosGraficos.labels = labels;
    dadosGraficos.receitas = receitas;
    dadosGraficos.despesas = despesas;
    dadosGraficos.gerais = gerais;

    // Configuração comum de datalabels para gráficos de barra
    const datalabelsConfig = {
        display: modoImpressao,
        anchor: 'end',
        align: 'top',
        font: {
            size: 20,
            weight: 'bold'
        },
        formatter: function(value) {
            return formatMoney(value);
        }
    };

    // Receita
    if (chartReceita) chartReceita.destroy();
    chartReceita = new Chart(document.getElementById('chartReceita'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Receita',
                data: receitas,
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        font: {
                            size: 13
                        }
                    }
                },
                datalabels: datalabelsConfig
            }
        }
    });

    // Despesa
    if (chartDespesa) chartDespesa.destroy();
    chartDespesa = new Chart(document.getElementById('chartDespesa'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Despesa',
                data: despesas,
                backgroundColor: '#dc3545'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        font: {
                            size: 13
                        }
                    }
                },
                datalabels: datalabelsConfig
            }
        }
    });

    // Geral
    if (chartGeral) chartGeral.destroy();
    chartGeral = new Chart(document.getElementById('chartGeral'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Geral',
                data: gerais,
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        font: {
                            size: 13
                        }
                    }
                },
                datalabels: datalabelsConfig
            }
        }
    });
}

function atualizarCategoriasDespesa(categorias, mediaReceitaPrevista, mediaReceitaRealizada, numMeses) {
    if (!categorias || Object.keys(categorias).length === 0) {
        document.getElementById('tabelaDespesas').innerHTML = '<tr><td colspan="4" class="text-center">Sem dados</td></tr>';
        return;
    }

    // Preparar dados para o gráfico de pizza
    const labels = [];
    const valores = [];
    const cores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];
    let totalRealizado = 0;
    let totalOrcado = 0;

    // Calcular total orçado e realizado de todas as despesas
    for (const codigo in categorias) {
        totalOrcado += Math.abs(categorias[codigo].orcado);
        totalRealizado += Math.abs(categorias[codigo].realizado);
    }

    // Ordenar por código
    const codigosOrdenados = Object.keys(categorias).sort();

    // Preparar dados do gráfico
    codigosOrdenados.forEach((codigo, index) => {
        const cat = categorias[codigo];
        labels.push(cat.nome);
        valores.push(Math.abs(cat.realizado)); // Usar valor absoluto para o gráfico
    });

    // Atualizar gráfico de pizza
    if (chartPizzaDespesa) chartPizzaDespesa.destroy();
    chartPizzaDespesa = new Chart(document.getElementById('chartPizzaDespesa'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: cores
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            size: 13
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                            return data.labels.map((label, i) => {
                                const value = data.datasets[0].data[i];
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return {
                                    text: `${label}: ${formatMoney(value)} (${percent}%)`,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${formatMoney(value)} (${percent}%)`;
                        }
                    }
                },
                datalabels: {
                    display: false
                }
            }
        }
    });

    // Atualizar tabela de despesas
    let htmlTabela = '';
    codigosOrdenados.forEach(codigo => {
        const cat = categorias[codigo];
        const orcado = cat.orcado;
        const realizado = cat.realizado;
        const diferenca = cat.diferenca;

        // Valores já vêm como média do Python (já dividido por numMeses)
        const mediaOrcado = orcado;
        const mediaRealizado = realizado;
        const mediaDiferenca = diferenca;

        // Calcular porcentagens
        // Média Prevista %: (média orçado da categoria / média receita prevista) * 100
        const percPrev = mediaReceitaPrevista !== 0 ? (Math.abs(mediaOrcado) / mediaReceitaPrevista * 100).toFixed(2) : '0.00';

        // Média Realizada %: (média realizado da categoria / média receita realizada) * 100
        const percReal = mediaReceitaRealizada !== 0 ? (Math.abs(mediaRealizado) / mediaReceitaRealizada * 100).toFixed(2) : '0.00';

        // Média Diferença: % Realizada - % Prevista
        const percDif = (parseFloat(percReal) - parseFloat(percPrev)).toFixed(2);

        htmlTabela += `
            <tr>
                <td><small>${cat.nome}</small></td>
                <td><small>${formatMoney(mediaOrcado)} (${percPrev}%)</small></td>
                <td><small>${formatMoney(mediaRealizado)} (${percReal}%)</small></td>
                <td><small>${formatMoney(mediaDiferenca)} (${percDif > 0 ? '+' : ''}${percDif}%)</small></td>
            </tr>
        `;
    });

    document.getElementById('tabelaDespesas').innerHTML = htmlTabela;
}

function atualizarCategoriasReceita(categorias, mediaReceitaPrevista, mediaReceitaRealizada, numMeses) {
    if (!categorias || Object.keys(categorias).length === 0) {
        document.getElementById('tabelaReceitas').innerHTML = '<tr><td colspan="4" class="text-center">Sem dados</td></tr>';
        return;
    }

    // Preparar dados para o gráfico de pizza
    const labels = [];
    const valores = [];
    const cores = ['#4BC0C0', '#36A2EB', '#FFCE56', '#FF6384', '#9966FF', '#FF9F40', '#C9CBCF', '#8DD1E1'];
    let totalRealizado = 0;
    let totalOrcado = 0;

    // Calcular totais
    for (const codigo in categorias) {
        totalRealizado += categorias[codigo].realizado;
        totalOrcado += categorias[codigo].orcado;
    }

    // Ordenar por código
    const codigosOrdenados = Object.keys(categorias).sort();

    // Preparar dados do gráfico
    codigosOrdenados.forEach((codigo, index) => {
        const cat = categorias[codigo];
        labels.push(cat.nome);
        valores.push(Math.abs(cat.realizado)); // Usar valor absoluto para o gráfico
    });

    // Atualizar gráfico de pizza
    if (chartPizzaReceita) chartPizzaReceita.destroy();
    chartPizzaReceita = new Chart(document.getElementById('chartPizzaReceita'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: cores
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            size: 13
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                            return data.labels.map((label, i) => {
                                const value = data.datasets[0].data[i];
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return {
                                    text: `${label}: ${formatMoney(value)} (${percent}%)`,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${formatMoney(value)} (${percent}%)`;
                        }
                    }
                },
                datalabels: {
                    display: false
                }
            }
        }
    });

    // Atualizar tabela de receitas
    let htmlTabela = '';
    codigosOrdenados.forEach(codigo => {
        const cat = categorias[codigo];
        const orcado = cat.orcado;
        const realizado = cat.realizado;
        const diferenca = cat.diferenca;

        // Valores já vêm como média do Python (já dividido por numMeses)
        const mediaOrcado = orcado;
        const mediaRealizado = realizado;
        const mediaDiferenca = diferenca;

        // Calcular porcentagens
        // Média Prevista %: (média orçado da categoria / média receita prevista) * 100
        const percPrev = mediaReceitaPrevista !== 0 ? (Math.abs(mediaOrcado) / mediaReceitaPrevista * 100).toFixed(2) : '0.00';

        // Média Realizada %: (média realizado da categoria / média receita realizada) * 100
        const percReal = mediaReceitaRealizada !== 0 ? (Math.abs(mediaRealizado) / mediaReceitaRealizada * 100).toFixed(2) : '0.00';

        // Média Diferença: % Realizada - % Prevista
        const percDif = (parseFloat(percReal) - parseFloat(percPrev)).toFixed(2);

        htmlTabela += `
            <tr>
                <td><small>${cat.nome}</small></td>
                <td><small>${formatMoney(mediaOrcado)} (${percPrev}%)</small></td>
                <td><small>${formatMoney(mediaRealizado)} (${percReal}%)</small></td>
                <td><small>${formatMoney(mediaDiferenca)} (${percDif > 0 ? '+' : ''}${percDif}%)</small></td>
            </tr>
        `;
    });

    document.getElementById('tabelaReceitas').innerHTML = htmlTabela;
}

// Gerar PDF usando impressão nativa do navegador
// Variáveis para armazenar dados dos gráficos (para recriar no modo impressão)
let dadosGraficos = {
    labels: [],
    receitas: [],
    despesas: [],
    gerais: []
};

function gerarPDF() {
    // Pegar valores dos filtros para mostrar no título da impressão
    const anoInicio = document.getElementById('ano_inicio').value;
    const mesInicio = document.getElementById('mes_inicio').value;
    const anoFim = document.getElementById('ano_fim').value;
    const mesFim = document.getElementById('mes_fim').value;
    const tipoDre = document.getElementById('tipo_dre').value;

    // Nomes dos meses
    const mesesNomes = ['', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

    // Atualizar período no título de impressão
    const periodoTexto = `${mesesNomes[parseInt(mesInicio)]}/${anoInicio} até ${mesesNomes[parseInt(mesFim)]}/${anoFim} - ${tipoDre}`;
    document.getElementById('print-periodo').textContent = periodoTexto;

    // Ativar modo impressão (mostra valores nas barras)
    modoImpressao = true;

    // Recriar gráficos de barra com valores visíveis
    atualizarGraficos(dadosGraficos.labels, dadosGraficos.receitas, dadosGraficos.despesas, dadosGraficos.gerais);

    // Aguardar renderização dos gráficos antes de imprimir
    setTimeout(function() {
        window.print();

        // Após imprimir, desativar modo impressão e recriar gráficos normais
        setTimeout(function() {
            modoImpressao = false;
            atualizarGraficos(dadosGraficos.labels, dadosGraficos.receitas, dadosGraficos.despesas, dadosGraficos.gerais);
        }, 500);
    }, 300);
}

// Carregar ao iniciar
atualizarDados();

// ========== CALENDÁRIO DE MESES ==========
const mesesDisponiveis = {{ meses_disponiveis|tojson }};
const nomesMeses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
let tipoSelecionando = ''; // 'inicio' ou 'fim'

function abrirCalendario(tipo) {
    tipoSelecionando = tipo;
    const modal = new bootstrap.Modal(document.getElementById('calendarioModal'));

    // Pegar ano atual do campo hidden
    const anoAtual = tipo === 'inicio'
        ? parseInt(document.getElementById('ano_inicio').value)
        : parseInt(document.getElementById('ano_fim').value);

    document.getElementById('anoCalendario').value = anoAtual;
    renderizarCalendario(anoAtual);
    modal.show();
}

function renderizarCalendario(ano) {
    const container = document.getElementById('calendarioMeses');
    container.innerHTML = '';

    // Criar grid de meses
    for (let mes = 1; mes <= 12; mes++) {
        const temDados = mesesDisponiveis.some(m => m.ano === ano && m.mes === mes);

        const mesDiv = document.createElement('div');
        mesDiv.className = `mes-item ${temDados ? 'disponivel' : 'indisponivel'}`;
        mesDiv.textContent = nomesMeses[mes - 1];

        if (temDados) {
            mesDiv.onclick = () => selecionarMes(mes, ano);
        }

        container.appendChild(mesDiv);
    }
}

function selecionarMes(mes, ano) {
    if (tipoSelecionando === 'inicio') {
        document.getElementById('mes_inicio').value = mes;
        document.getElementById('ano_inicio').value = ano;
        document.getElementById('periodo_inicio_display').value = `${nomesMeses[mes-1]}/${ano}`;
    } else {
        document.getElementById('mes_fim').value = mes;
        document.getElementById('ano_fim').value = ano;
        document.getElementById('periodo_fim_display').value = `${nomesMeses[mes-1]}/${ano}`;
    }

    bootstrap.Modal.getInstance(document.getElementById('calendarioModal')).hide();
}

function mudarAnoCalendario(direcao) {
    const inputAno = document.getElementById('anoCalendario');
    const anoAtual = parseInt(inputAno.value);
    const novoAno = anoAtual + direcao;

    inputAno.value = novoAno;
    renderizarCalendario(novoAno);
}

// Inicializar valores de display ao carregar com base nos meses disponíveis
window.addEventListener('DOMContentLoaded', function() {
    if (mesesDisponiveis && mesesDisponiveis.length > 0) {
        // Ordenar por ano e mês para encontrar o primeiro e último
        const ordenados = [...mesesDisponiveis].sort((a, b) => {
            if (a.ano !== b.ano) return a.ano - b.ano;
            return a.mes - b.mes;
        });

        const primeiro = ordenados[0];
        const ultimo = ordenados[ordenados.length - 1];

        // Atualizar os hidden inputs com o período real dos dados
        document.getElementById('mes_inicio').value = primeiro.mes;
        document.getElementById('ano_inicio').value = primeiro.ano;
        document.getElementById('mes_fim').value = ultimo.mes;
        document.getElementById('ano_fim').value = ultimo.ano;

        // Atualizar os displays
        document.getElementById('periodo_inicio_display').value = `${nomesMeses[primeiro.mes-1]}/${primeiro.ano}`;
        document.getElementById('periodo_fim_display').value = `${nomesMeses[ultimo.mes-1]}/${ultimo.ano}`;
    } else {
        const mesInicio = parseInt(document.getElementById('mes_inicio').value);
        const anoInicio = parseInt(document.getElementById('ano_inicio').value);
        const mesFim = parseInt(document.getElementById('mes_fim').value);
        const anoFim = parseInt(document.getElementById('ano_fim').value);

        document.getElementById('periodo_inicio_display').value = `${nomesMeses[mesInicio-1]}/${anoInicio}`;
        document.getElementById('periodo_fim_display').value = `${nomesMeses[mesFim-1]}/${anoFim}`;
    }
});

// ========== RELATÓRIO IA (BPO) ==========
function gerarRelatorioIA_BPO() {
    if (!dadosBPOAtuais) {
        alert('Dados não carregados. Por favor, clique em Filtrar primeiro.');
        return;
    }

    // Mostrar loading
    const btnIA = document.getElementById('btnRelatorioIA');
    const textoOriginal = btnIA.innerHTML;
    btnIA.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Gerando...';
    btnIA.disabled = true;

    // Montar período para exibição
    const mesInicio = parseInt(document.getElementById('mes_inicio').value);
    const anoInicio = parseInt(document.getElementById('ano_inicio').value);
    const mesFim = parseInt(document.getElementById('mes_fim').value);
    const anoFim = parseInt(document.getElementById('ano_fim').value);
    const nomesMesesCompletos = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

    let periodo;
    if (anoInicio === anoFim) {
        periodo = `${nomesMesesCompletos[mesInicio-1]} a ${nomesMesesCompletos[mesFim-1]} de ${anoFim}`;
    } else {
        periodo = `${nomesMesesCompletos[mesInicio-1]}/${anoInicio} a ${nomesMesesCompletos[mesFim-1]}/${anoFim}`;
    }

    // Montar dados para enviar à IA (dos 3 DREs)
    const dadosParaIA = {
        periodo: periodo,
        num_meses: dadosBPOAtuais.num_meses || 1,
        totais_acumulados: dadosBPOAtuais.totais_acumulados,
        totais_orcamento: dadosBPOAtuais.totais_orcamento,
        categorias_despesa: dadosBPOAtuais.categorias_despesa,
        categorias_receita: dadosBPOAtuais.categorias_receita
    };

    // Enviar para a API
    {% if is_user_view %}
    const urlIA = '/user/api/relatorio-ia-bpo/{{ empresa_id }}';
    {% else %}
    const urlIA = '/admin/api/relatorio-ia-bpo/{{ empresa_id }}';
    {% endif %}

    fetch(urlIA, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dadosParaIA)
    })
    .then(response => response.json())
    .then(data => {
        btnIA.innerHTML = textoOriginal;
        btnIA.disabled = false;

        if (data.success) {
            abrirModalRelatorioIA_BPO(data.relatorio);
        } else {
            alert('Erro ao gerar relatório: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        btnIA.innerHTML = textoOriginal;
        btnIA.disabled = false;
        console.error('Erro:', error);
        alert('Erro ao gerar relatório. Verifique o console para mais detalhes.');
    });
}

// Abrir modal com relatório IA BPO
function abrirModalRelatorioIA_BPO(conteudoRelatorio) {
    let modal = document.getElementById('modalRelatorioIA_BPO');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalRelatorioIA_BPO';
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
                        <h5 class="modal-title">
                            <i class="bi bi-robot me-2"></i>Relatório Executivo DRE (IA)
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="conteudoRelatorioIA_BPO" style="font-family: inherit; line-height: 1.6;">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary" onclick="copiarRelatorioIA_BPO()">
                            <i class="bi bi-clipboard me-1"></i>Copiar
                        </button>
                        <button type="button" class="btn btn-danger" onclick="imprimirRelatorioIA_BPO()">
                            <i class="bi bi-printer me-1"></i>Imprimir
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    const conteudo = document.getElementById('conteudoRelatorioIA_BPO');
    conteudo.innerHTML = formatarConteudoIA(conteudoRelatorio);

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Formatar conteúdo (HTML ou Markdown) para exibição
function formatarConteudoIA(conteudo) {
    if (conteudo.trim().startsWith('<') || conteudo.includes('<table') || conteudo.includes('<h1>') || conteudo.includes('<h2>')) {
        let html = conteudo
            .replace(/^```html\s*/i, '')
            .replace(/```\s*$/i, '')
            .trim();
        return `<div class="relatorio-ia-content">${html}</div>`;
    }

    let html = conteudo
        .replace(/^### (.*$)/gim, '<h5>$1</h5>')
        .replace(/^## (.*$)/gim, '<h4 class="mt-4 mb-3 text-primary">$1</h4>')
        .replace(/^# (.*$)/gim, '<h3 class="mt-4 mb-3">$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\* (.*$)/gim, '<li>$1</li>')
        .replace(/^- (.*$)/gim, '<li>$1</li>')
        .replace(/\n/g, '<br>');

    html = html.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
    return `<div class="relatorio-ia-content">${html}</div>`;
}

// Copiar relatório BPO para clipboard
function copiarRelatorioIA_BPO() {
    const conteudo = document.getElementById('conteudoRelatorioIA_BPO').innerText;
    navigator.clipboard.writeText(conteudo).then(() => {
        alert('Relatório copiado para a área de transferência!');
    });
}

// Imprimir relatório BPO
function imprimirRelatorioIA_BPO() {
    const conteudo = document.getElementById('conteudoRelatorioIA_BPO').innerHTML;
    const janela = window.open('', '_blank');
    janela.document.write(`
        <html>
        <head>
            <title>Relatório Executivo DRE - {{ empresa_nome }}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; max-width: 1000px; margin: 0 auto; }
                h1 { color: #333; font-size: 24px; margin-bottom: 10px; }
                h2 { color: #7c3aed; font-size: 18px; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid #7c3aed; padding-bottom: 8px; }
                h3 { color: #555; font-size: 16px; margin-top: 20px; margin-bottom: 10px; }
                hr { border: none; border-top: 1px solid #ddd; margin: 20px 0; }
                p { margin: 10px 0; }
                table { border-collapse: collapse; width: 100%; margin: 15px 0; font-size: 14px; }
                th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
                th { background-color: #e0e0e0; font-weight: bold; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                ul, ol { margin: 10px 0; padding-left: 25px; }
                li { margin: 5px 0; }
                strong { color: #333; }
                em { color: #666; }
                @media print {
                    body { padding: 0; }
                    table { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>${conteudo}</body>
        </html>
    `);
    janela.document.close();
    janela.print();
}
</script>

<!-- MODAL CALENDÁRIO -->
<div class="modal fade" id="calendarioModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar3 me-2"></i>
                    Selecione o Mês
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="calendario-header">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="mudarAnoCalendario(-1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <input type="number" id="anoCalendario" class="form-control form-control-sm text-center"
                           value="2025" min="2000" max="2100"
                           onchange="renderizarCalendario(parseInt(this.value))">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="mudarAnoCalendario(1)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div id="calendarioMeses" class="calendario-meses"></div>
                <div class="calendario-legenda">
                    <div><span class="legenda-box disponivel"></span> Meses com dados</div>
                    <div><span class="legenda-box indisponivel"></span> Sem dados</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.calendario-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.calendario-header input {
    max-width: 100px;
}

.calendario-meses {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.mes-item {
    padding: 1rem;
    text-align: center;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.mes-item.disponivel {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
}

.mes-item.disponivel:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
}

.mes-item.indisponivel {
    background: #f1f5f9;
    color: #94a3b8;
    cursor: not-allowed;
}

.calendario-legenda {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
    font-size: 0.875rem;
    color: #64748b;
}

.calendario-legenda > div {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legenda-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.legenda-box.disponivel {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.legenda-box.indisponivel {
    background: #f1f5f9;
}
</style>

{% endblock %}
