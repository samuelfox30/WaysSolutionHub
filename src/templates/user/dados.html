{% extends "user/base.html" %}

{% block header_title %}Dados Detalhados{% endblock %}
{% block header_subtitle %}Visualize e filtre seus dados financeiros anuais{% endblock %}

{% block content %}
<style>
    :root {
        --orange-primary: #ff9900;
        --orange-light: #ffb347;
        --orange-dark: #cc7a00;
        --orange-bg: #fff5e6;
    }

    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .btn-primary {
        background-color: var(--orange-primary) !important;
        border-color: var(--orange-dark) !important;
    }

    .btn-primary:hover {
        background-color: var(--orange-dark) !important;
    }

    .btn-filter {
        transition: all 0.3s ease;
        border: 2px solid #dee2e6;
        font-weight: 500;
    }

    .btn-filter:hover {
        border-color: var(--orange-primary);
        color: var(--orange-primary);
    }

    .btn-filter.active {
        background-color: var(--orange-primary) !important;
        border-color: var(--orange-primary) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(255, 153, 0, 0.25) !important;
    }

    /* Reutiliza estilos da consulta do admin */
    .table-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        margin-bottom: 2rem;
        overflow: hidden;
        border: 1px solid #e9ecef;
    }

    .section-header {
        background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-light) 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px 10px 0 0;
        margin: 0;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .table-card-body {
        padding: 1.5rem;
    }

    .grupo-principal {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem 1.5rem;
        margin: 0 -1.5rem 1rem -1.5rem;
        border-left: 5px solid var(--orange-primary);
        font-weight: 700;
        font-size: 1.1rem;
        color: #495057;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-real { background-color: #28a745; color: white; }
    .badge-pe { background-color: #ffc107; color: #333; }
    .badge-ideal { background-color: #007bff; color: white; }

    .subgrupo-header {
        background-color: #f1f3f5;
        padding: 0.75rem 1rem;
        margin: 1rem -1.5rem 0.5rem -1.5rem;
        border-left: 3px solid var(--orange-dark);
        font-weight: 600;
        font-size: 0.95rem;
        color: #495057;
        display: flex;
        align-items: center;
    }

    .tabela-itens {
        width: 100%;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
    }

    .tabela-itens thead th {
        background-color: #ffffff;
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #dee2e6;
        padding: 0.5rem 0.75rem;
        text-align: left;
    }

    .tabela-itens thead th:not(:first-child) {
        text-align: right;
    }

    .tabela-itens tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #f1f3f5;
    }

    .tabela-itens tbody tr:hover {
        background-color: var(--orange-bg);
        transform: translateX(5px);
    }

    .tabela-itens td {
        padding: 0.65rem 0.75rem;
        vertical-align: middle;
    }

    .item-descricao {
        color: #495057;
        font-weight: 500;
        padding-left: 2rem !important;
        position: relative;
    }

    .item-descricao::before {
        content: "▸";
        position: absolute;
        left: 0.75rem;
        color: var(--orange-primary);
        font-size: 0.8rem;
    }

    .valor-positivo { color: #28a745; font-weight: 600; }
    .valor-negativo { color: #dc3545; font-weight: 600; }
    .valor-neutral { color: #6c757d; }

    .grupo-separador {
        border-top: 2px dashed #dee2e6;
        margin: 2rem -1.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        color: var(--orange-light);
        margin-bottom: 1rem;
    }

    .info-banner {
        background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        border-left: 4px solid var(--orange-primary);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .info-banner-text {
        font-size: 0.875rem;
        color: #92400e;
        font-weight: 500;
        margin: 0;
    }
</style>

<!-- Filtros -->
<div class="filter-card">
    <h5 class="mb-3"><i class="bi bi-funnel me-2"></i> Filtros</h5>
    <form method="GET" class="row g-3">
        <div class="col-md-6">
            <label for="ano" class="form-label fw-semibold">Ano:</label>
            <input type="number" name="ano" id="ano" class="form-control" value="{{ ano_selecionado or '' }}" placeholder="Ex: 2025" required>
        </div>

        <div class="col-md-6 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-search me-2"></i> Buscar Dados
            </button>
        </div>
    </form>
</div>

{% if data_results %}
    <!-- Banner Informativo -->
    <div class="info-banner">
        <p class="info-banner-text">
            <i class="bi bi-calendar-check me-2"></i>
            <strong>Dados do Ano {{ ano_selecionado }}</strong> - Visualizando informações financeiras anuais
        </p>
    </div>

    <!-- Filtro por Grupo -->
    <div class="filter-card">
        <label class="form-label fw-semibold mb-2">
            <i class="bi bi-filter me-2"></i> Filtrar por Grupo:
        </label>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-sm btn-filter active" onclick="filtrarGrupo('todos', this)">
                <i class="bi bi-grid-3x3-gap me-1"></i> Todos
            </button>
            <button type="button" class="btn btn-sm btn-filter" onclick="filtrarGrupo('Viabilidade Real', this)">
                <i class="bi bi-circle-fill text-success me-1"></i> Real
            </button>
            <button type="button" class="btn btn-sm btn-filter" onclick="filtrarGrupo('Viabilidade PE', this)">
                <i class="bi bi-circle-fill text-warning me-1"></i> PE
            </button>
            <button type="button" class="btn btn-sm btn-filter" onclick="filtrarGrupo('Viabilidade Ideal', this)">
                <i class="bi bi-circle-fill text-primary me-1"></i> Ideal
            </button>
        </div>
    </div>

    {% set tables_config = [
        ('Itens Normais', 'TbItens', ['Descrição', 'Percentual (%)', 'Valor (R$)'], 'bi-list-ul'),
        ('Investimentos', 'TbItensInvestimentos', ['Descrição', 'Parcela (R$)', 'Juros (R$)', 'Total Parcela (R$)'], 'bi-currency-exchange'),
        ('Dívidas', 'TbItensDividas', ['Descrição', 'Parcela (R$)', 'Juros (R$)', 'Total Parcela (R$)'], 'bi-cash-coin'),
        ('Investimento Geral', 'TbItensInvestimentoGeral', ['Descrição', 'Valor (R$)'], 'bi-graph-up-arrow'),
        ('Gastos Operacionais', 'TbItensGastosOperacionais', ['Descrição', 'Custo por KM (R$)', 'Custo Mensal (R$)'], 'bi-fuel-pump')
    ] %}

    {% for title, key, headers, icon in tables_config %}
        {% if data_results[key] %}
            <div class="table-card">
                <h3 class="section-header">
                    <i class="{{ icon }} me-2"></i> {{ title }}
                    <span class="badge bg-light text-dark ms-2" id="contador-{{ key }}">
                        {{ data_results[key]|length }} registros
                    </span>
                </h3>
                
                <div class="table-card-body">
                    {% set grupos_organizados = {} %}
                    {% for row in data_results[key] %}
                        {% set grupo = row[0] %}
                        {% set subgrupo = row[1] %}
                        
                        {% if grupo not in grupos_organizados %}
                            {% set _ = grupos_organizados.update({grupo: {}}) %}
                        {% endif %}
                        
                        {% if subgrupo not in grupos_organizados[grupo] %}
                            {% set _ = grupos_organizados[grupo].update({subgrupo: []}) %}
                        {% endif %}
                        
                        {% set _ = grupos_organizados[grupo][subgrupo].append(row[2:]) %}
                    {% endfor %}

                    {% for grupo, subgrupos in grupos_organizados.items() %}
                        <div class="grupo-container" data-grupo="{{ grupo }}">
                            {% set badge_class = 'badge-real' if 'real' in grupo|lower else ('badge-pe' if 'pe' in grupo|lower else 'badge-ideal') %}
                            <div class="grupo-principal">
                                <span class="badge {{ badge_class }} me-2">{{ grupo }}</span>
                            </div>

                            {% for subgrupo, itens in subgrupos.items() %}
                                <div class="subgrupo-header">
                                    <i class="bi bi-folder2-open me-2" style="color: #ff9900;"></i>
                                    {{ subgrupo }}
                                </div>

                                <table class="tabela-itens">
                                    <thead>
                                        <tr>
                                            {% for header in headers %}
                                                <th>{{ header }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in itens %}
                                            <tr>
                                                <td class="item-descricao">{{ item[0] }}</td>
                                                
                                                {% for valor in item[1:] %}
                                                    <td class="text-end">
                                                        {% if valor is number and valor != 0 %}
                                                            <span class="{{ 'valor-positivo' if valor > 0 else 'valor-negativo' }}">
                                                                {{ "R$ {:,.2f}".format(valor).replace(',', 'X').replace('.', ',').replace('X', '.') if valor|abs >= 0.01 else "R$ 0,00" }}
                                                            </span>
                                                        {% elif valor is number and valor == 0 %}
                                                            <span class="valor-neutral">R$ 0,00</span>
                                                        {% else %}
                                                            {{ valor }}
                                                        {% endif %}
                                                    </td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endfor %}

                            {% if not loop.last %}
                                <div class="grupo-separador"></div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endfor %}

{% else %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h3 class="h5 text-muted">Nenhum dado encontrado</h3>
        <p class="text-muted">Selecione um ano para visualizar os dados financeiros.</p>
    </div>
{% endif %}

<script>
function filtrarGrupo(grupoFiltro, clickedButton) {
    const grupoContainers = document.querySelectorAll(".grupo-container");
    const filterButtons = document.querySelectorAll(".btn-filter");
    
    filterButtons.forEach(btn => btn.classList.remove('active'));
    if (clickedButton) {
        clickedButton.classList.add('active');
    }

    grupoContainers.forEach(container => {
        const grupo = container.dataset.grupo;
        container.style.display = (grupoFiltro === "todos" || grupo === grupoFiltro) ? "block" : "none";
    });

    atualizarContadores();
}

function atualizarContadores() {
    document.querySelectorAll('.table-card').forEach(card => {
        const visibleGroups = card.querySelectorAll('.grupo-container:not([style*="display: none"])');
        let totalVisible = 0;
        
        visibleGroups.forEach(group => {
            totalVisible += group.querySelectorAll('tbody tr').length;
        });
        
        const totalRows = card.querySelectorAll('tbody tr').length;
        const badge = card.querySelector('.section-header .badge');
        
        if (badge) {
            badge.textContent = totalVisible === totalRows 
                ? `${totalRows} registros` 
                : `${totalVisible} de ${totalRows} registros`;
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('.grupo-container')) {
        filtrarGrupo('todos');
    }
});
</script>
{% endblock %}