{% extends "user/base.html" %}

{% block header_title %}Consultar Dados BPO - Tabela Completa{% endblock %}
{% block header_subtitle %}Visualize os dados mensais de BPO em formato de planilha{% endblock %}

{% block content %}

<style>
    .filter-card {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
    }

    .filter-card h5 {
        font-weight: 700;
        margin-bottom: 20px;
        font-size: 1.3rem;
    }

    .filter-card .form-label {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .filter-card .form-select,
    .filter-card .form-control {
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 10px 15px;
        font-weight: 500;
    }

    .btn-consultar {
        background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
        border: none;
        color: white;
        padding: 12px 40px;
        font-weight: 700;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        transition: all 0.3s ease;
    }

    .btn-consultar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 107, 53, 0.6);
        background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
    }

    /* Tabela tipo Excel */
    .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .table-scroll {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 70vh;
    }

    .excel-table {
        width: auto;
        min-width: 100%;
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.85rem;
    }

    .excel-table thead th {
        position: sticky;
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        font-weight: 700;
        text-align: center;
        padding: 15px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        white-space: nowrap;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Primeira linha do cabe√ßalho (meses) */
    .excel-table thead tr:first-child th {
        top: 0;
        z-index: 101;
    }

    /* Segunda linha do cabe√ßalho (subcolunas) */
    .excel-table thead tr:nth-child(2) th {
        top: 58px; /* Altura da primeira linha */
        z-index: 100;
    }

    .excel-table thead th:first-child {
        position: sticky;
        left: 0;
        z-index: 150;
        min-width: 300px;
        text-align: left;
    }

    /* Garantir que a primeira coluna de ambas as linhas fique fixa */
    .excel-table thead tr:first-child th:first-child {
        z-index: 151;
    }

    .excel-table thead tr:nth-child(2) th:first-child {
        z-index: 150;
    }

    .excel-table tbody tr {
        transition: all 0.2s ease;
    }

    .excel-table tbody tr:hover {
        background-color: #fff4e6;
        box-shadow: 0 2px 8px rgba(255, 107, 53, 0.1);
    }

    .excel-table tbody td {
        padding: 12px;
        border: 1px solid #e9ecef;
        white-space: nowrap;
        text-align: right;
        font-weight: 500;
    }

    .excel-table tbody td:first-child {
        position: sticky;
        left: 0;
        background: white;
        font-weight: 600;
        text-align: left;
        z-index: 50;
        border-right: 2px solid #dee2e6;
        white-space: normal;
        word-wrap: break-word;
        min-width: 300px;
        max-width: 300px;
    }

    .excel-table tbody tr:hover td:first-child {
        background-color: #fff4e6;
    }

    /* Indenta√ß√£o de hierarquia */
    .nivel-1 { padding-left: 10px !important; font-weight: 700; }
    .nivel-2 { padding-left: 30px !important; font-weight: 600; }
    .nivel-3 { padding-left: 50px !important; }
    .nivel-4 { padding-left: 70px !important; }
    .nivel-5 { padding-left: 90px !important; }

    /* Colunas de totais */
    .col-total {
        background-color: #fff4e6;
        font-weight: 700;
        border-left: 3px solid #ff8c42 !important;
    }

    /* Valores condicionais */
    .valor-positivo {
        color: #10b981;
        font-weight: 600;
    }

    .valor-negativo {
        color: #ef4444;
        font-weight: 600;
    }

    .valor-neutro {
        color: #6b7280;
        font-weight: 500;
    }

    /* Tabelas de cen√°rios */
    .cenarios-section {
        margin-top: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #fef3e7 0%, #ffe5cc 100%);
        border-radius: 15px;
    }

    .cenario-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(255, 107, 53, 0.1);
        border: 1px solid rgba(255, 140, 66, 0.2);
    }

    .cenario-card h6 {
        font-weight: 700;
        margin-bottom: 15px;
        color: #ff6b35;
        font-size: 1.1rem;
    }

    .cenario-table {
        width: 100%;
        font-size: 0.9rem;
    }

    .cenario-table thead th {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        font-weight: 600;
        padding: 12px;
        text-align: center;
    }

    .cenario-table tbody td {
        padding: 10px 12px;
        text-align: right;
        font-weight: 500;
    }

    .cenario-table tbody td:first-child {
        text-align: left;
        font-weight: 600;
        color: #ff6b35;
    }

    /* Loading spinner */
    .loading {
        text-align: center;
        padding: 50px;
        font-size: 1.2rem;
        color: #ff6b35;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }

    /* Bot√£o maximizar */
    .btn-maximizar {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }

    .btn-maximizar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
    }

    /* Modo tela cheia */
    .fullscreen-mode {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 9999;
        padding: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .fullscreen-mode .table-scroll {
        flex: 1;
        overflow: auto;
        max-height: calc(100vh - 80px);
    }

    /* Garantir que o cabe√ßalho fique fixo em tela cheia */
    .fullscreen-mode .excel-table thead tr:first-child th {
        top: 0;
        z-index: 101;
    }

    .fullscreen-mode .excel-table thead tr:nth-child(2) th {
        top: 58px;
        z-index: 100;
    }

    .fullscreen-mode .excel-table thead tr:first-child th:first-child {
        z-index: 151;
    }

    .fullscreen-mode .excel-table thead tr:nth-child(2) th:first-child {
        z-index: 150;
    }

    .fullscreen-mode .excel-table tbody td:first-child {
        z-index: 50;
    }
</style>

<div class="container-fluid px-4">

    <!-- CARD DE FILTROS -->
    <div class="filter-card">
        <h5><i class="bi bi-funnel-fill me-2"></i>Filtro de Per√≠odo - {{ empresa_nome }}</h5>

        <!-- Campo hidden com empresa_id -->
        <input type="hidden" id="empresa_id" value="{{ empresa_id }}">

        <div class="row g-3">
            <!-- M√™s In√≠cio -->
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar-check me-1"></i>M√™s In√≠cio</label>
                <select class="form-select" id="mes_inicio">
                    <option value="1" selected>Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Mar√ßo</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
            </div>

            <!-- Ano In√≠cio -->
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar4 me-1"></i>Ano In√≠cio</label>
                <input type="number" class="form-control" id="ano_inicio" min="2000" max="2100" value="2025">
            </div>

            <!-- M√™s Fim -->
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar-x me-1"></i>M√™s Fim</label>
                <select class="form-select" id="mes_fim">
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Mar√ßo</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12" selected>Dezembro</option>
                </select>
            </div>

            <!-- Ano Fim -->
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar4 me-1"></i>Ano Fim</label>
                <input type="number" class="form-control" id="ano_fim" min="2000" max="2100" value="2025">
            </div>

            <!-- Bot√£o Consultar -->
            <div class="col-md-12">
                <button class="btn btn-consultar w-100" onclick="carregarDados()">
                    <i class="bi bi-search me-2"></i>Consultar Dados BPO
                </button>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Carregando dados...</p>
    </div>

    <!-- TABELA PRINCIPAL -->
    <div id="table-container" class="table-container" style="display: none;">
        <div class="d-flex justify-content-end">
            <button class="btn btn-maximizar" onclick="toggleFullscreen()" id="btn-fullscreen">
                <i class="bi bi-arrows-fullscreen me-2"></i>Tela Cheia
            </button>
        </div>
        <div class="table-scroll">
            <table class="excel-table" id="excel-table">
                <thead id="table-header">
                    <!-- Cabe√ßalho ser√° gerado dinamicamente -->
                </thead>
                <tbody id="table-body">
                    <!-- Corpo ser√° gerado dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- CEN√ÅRIOS -->
    <div id="cenarios-section" class="cenarios-section" style="display: none;">
        <h4 class="text-center mb-4" style="font-weight: 700; color: #ff6b35;">
            <i class="bi bi-calculator-fill me-2"></i>Totais Calculados por Cen√°rio
        </h4>

        <!-- Fluxo de Caixa -->
        <div class="cenario-card">
            <h6><i class="bi bi-cash-stack me-2"></i>Resultado por Fluxo de Caixa</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead id="fc-header-row">
                        <!-- Cabe√ßalho ser√° preenchido dinamicamente -->
                    </thead>
                    <tbody id="fc-body">
                        <!-- Ser√° preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resultado Real -->
        <div class="cenario-card">
            <h6><i class="bi bi-graph-up-arrow me-2"></i>Resultado Real</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead id="real-header-row">
                        <!-- Cabe√ßalho ser√° preenchido dinamicamente -->
                    </thead>
                    <tbody id="real-body">
                        <!-- Ser√° preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resultado Real + MP -->
        <div class="cenario-card">
            <h6><i class="bi bi-pie-chart-fill me-2"></i>Resultado Real + Custo Mat√©ria Prima</h6>
            <div class="table-responsive">
                <table class="table cenario-table">
                    <thead id="realmp-header-row">
                        <!-- Cabe√ßalho ser√° preenchido dinamicamente -->
                    </thead>
                    <tbody id="realmp-body">
                        <!-- Ser√° preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
function formatMoney(value) {
    if (value === null || value === undefined) return '-';
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

function formatMoneyCondicional(value) {
    if (value === null || value === undefined) return '<span class="valor-neutro">-</span>';

    const formatted = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);

    if (value > 0) {
        return `<span class="valor-positivo"><i class="bi bi-arrow-up-circle-fill me-1"></i>${formatted}</span>`;
    } else if (value < 0) {
        return `<span class="valor-negativo"><i class="bi bi-arrow-down-circle-fill me-1"></i>${formatted}</span>`;
    } else {
        return `<span class="valor-neutro">${formatted}</span>`;
    }
}

function formatPercent(value) {
    if (value === null || value === undefined) return '-';
    return value.toFixed(2) + '%';
}

function formatPercentCondicional(value) {
    if (value === null || value === undefined) return '<span class="valor-neutro">-</span>';

    const formatted = value.toFixed(2) + '%';

    if (value >= 100) {
        return `<span class="valor-positivo"><i class="bi bi-check-circle-fill me-1"></i>${formatted}</span>`;
    } else if (value >= 80) {
        return `<span style="color: #f59e0b; font-weight: 600;"><i class="bi bi-exclamation-circle-fill me-1"></i>${formatted}</span>`;
    } else {
        return `<span class="valor-negativo"><i class="bi bi-x-circle-fill me-1"></i>${formatted}</span>`;
    }
}

async function carregarDados() {
    const empresaId = document.getElementById('empresa_id').value;
    const mesInicio = document.getElementById('mes_inicio').value;
    const anoInicio = document.getElementById('ano_inicio').value;
    const mesFim = document.getElementById('mes_fim').value;
    const anoFim = document.getElementById('ano_fim').value;

    if (!empresaId) {
        alert('Selecione uma empresa');
        return;
    }

    // Mostrar loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('table-container').style.display = 'none';
    document.getElementById('cenarios-section').style.display = 'none';

    try {
        const url = `/user/api/dados-bpo-tabela/${empresaId}?mes_inicio=${mesInicio}&ano_inicio=${anoInicio}&mes_fim=${mesFim}&ano_fim=${anoFim}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.error) {
            alert('Erro: ' + data.error);
            document.getElementById('loading').style.display = 'none';
            return;
        }

        // Renderizar tabela
        renderizarTabela(data);

        // Renderizar cen√°rios
        renderizarCenarios(data);

        // Mostrar tabelas
        document.getElementById('loading').style.display = 'none';
        document.getElementById('table-container').style.display = 'block';
        document.getElementById('cenarios-section').style.display = 'block';

    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar dados: ' + error.message);
        document.getElementById('loading').style.display = 'none';
    }
}

function renderizarTabela(data) {
    const { itens, meses } = data;

    // Encontrar o item RECEITA e mapear valores or√ßados e realizados por m√™s
    const receitaPorMes = {};
    const receitaRealizadaPorMes = {};
    const itemReceita = itens.find(item =>
        item.codigo === "1" ||
        item.nome.toUpperCase().includes("RECEITA") && item.codigo.startsWith("1")
    );

    if (itemReceita) {
        meses.forEach(mes => {
            const chave = `${mes.ano}_${mes.mes_numero}`;
            const dados = itemReceita.dados_mensais[chave];
            if (dados) {
                if (dados.valor_orcado) {
                    receitaPorMes[chave] = dados.valor_orcado;
                }
                if (dados.valor_realizado) {
                    receitaRealizadaPorMes[chave] = dados.valor_realizado;
                }
            }
        });
    }

    console.log('üìä Item RECEITA encontrado:', itemReceita);
    console.log('üí∞ Receita Or√ßada por m√™s:', receitaPorMes);
    console.log('üíµ Receita Realizada por m√™s:', receitaRealizadaPorMes);

    // Gerar cabe√ßalho
    let headerHTML = '<tr><th>Descri√ß√£o</th>';

    // Colunas dos meses (6 colunas por m√™s agora)
    meses.forEach(mes => {
        headerHTML += `
            <th colspan="6" style="border-bottom: 3px solid white;">${mes.mes_nome} ${mes.ano}</th>
        `;
    });

    // Colunas de totais (7 colunas agora)
    headerHTML += `<th colspan="7" style="background: #ffd54f; color: #333; border-left: 3px solid #333;">Totais do Per√≠odo</th>`;
    headerHTML += '</tr>';

    // Segunda linha do cabe√ßalho com subcolunas
    headerHTML += '<tr><th></th>';
    meses.forEach(() => {
        headerHTML += `
            <th>Or√ßado</th>
            <th>% Or√ßado</th>
            <th>Realizado</th>
            <th>% Realizado</th>
            <th>% Atingido</th>
            <th>Diferen√ßa</th>
        `;
    });
    headerHTML += `
        <th class="col-total">Total Or√ßado</th>
        <th class="col-total">Total Realizado</th>
        <th class="col-total">Diferen√ßa</th>
        <th class="col-total">Realizado M√©dia</th>
        <th class="col-total">% Realizado M√©dia</th>
        <th class="col-total">M√©dia Diferen√ßa</th>
        <th class="col-total">% M√©dia Diferen√ßa</th>
    `;
    headerHTML += '</tr>';

    document.getElementById('table-header').innerHTML = headerHTML;

    // Calcular n√∫mero de meses para as m√©dias
    const numMeses = meses.length;

    // Calcular Total Realizado M√©dia da RECEITA (item c√≥digo "1")
    let receitaRealizadoMedia = 0;
    if (itemReceita) {
        let totalReceitaRealizada = 0;
        meses.forEach(mes => {
            const chave = `${mes.ano}_${mes.mes_numero}`;
            const dados = itemReceita.dados_mensais[chave];
            if (dados && dados.valor_realizado) {
                totalReceitaRealizada += dados.valor_realizado;
            }
        });
        receitaRealizadoMedia = numMeses > 0 ? totalReceitaRealizada / numMeses : 0;
    }

    // Gerar corpo da tabela
    let bodyHTML = '';

    itens.forEach(item => {
        // Ocultar linhas que n√£o possuem c√≥digo
        if (!item.codigo) {
            return; // Pular este item
        }

        bodyHTML += `<tr>`;

        // Coluna de descri√ß√£o com hierarquia
        bodyHTML += `<td class="nivel-${item.nivel_hierarquia}">`;
        if (item.codigo) {
            bodyHTML += `<code>${item.codigo}</code> `;
        }
        bodyHTML += `${item.nome}</td>`;

        // Detectar se √© DESPESA (a partir da linha "2 DESPESAS")
        const isDespesa = item.codigo && item.codigo.startsWith('2');

        // Calcular totais
        let totalOrcado = 0;
        let totalRealizado = 0;

        // Dados mensais
        meses.forEach(mes => {
            const chave = `${mes.ano}_${mes.mes_numero}`;
            const dados = item.dados_mensais[chave];

            if (dados) {
                const orcado = dados.valor_orcado || 0;
                const realizado = dados.valor_realizado || 0;
                const perc = dados.perc_atingido || 0;
                const dif = dados.valor_diferenca || 0;

                totalOrcado += orcado;
                totalRealizado += realizado;

                // Calcular % Or√ßado (percentual sobre a RECEITA or√ßada do m√™s)
                const receitaMes = receitaPorMes[chave] || 0;
                let percOrcado = 0;
                if (receitaMes > 0) {
                    percOrcado = (orcado / receitaMes) * 100;
                }

                // Calcular % Realizado (percentual sobre a RECEITA realizada do m√™s)
                const receitaRealizadaMes = receitaRealizadaPorMes[chave] || 0;
                let percRealizado = 0;
                if (receitaRealizadaMes > 0) {
                    percRealizado = (realizado / receitaRealizadaMes) * 100;
                }

                // Calcular % Atingido: % Realizada - % Or√ßada
                const percAtingido = percRealizado - percOrcado;

                bodyHTML += `
                    <td>${formatMoney(orcado)}</td>
                    <td style="color: #6b7280; font-weight: 500;">${formatPercent(percOrcado)}</td>
                    <td>${formatMoney(realizado)}</td>
                    <td style="color: #6b7280; font-weight: 500;">${formatPercent(percRealizado)}</td>
                    <td style="font-weight: 600;">${formatPercent(percAtingido)}</td>
                    <td>${formatMoneyCondicional(dif)}</td>
                `;
            } else {
                bodyHTML += `<td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>`;
            }
        });

        // Totais
        // Diferen√ßa Total: inverte c√°lculo para receitas vs despesas
        const totalDif = isDespesa
            ? totalOrcado - totalRealizado  // DESPESAS: Or√ßado - Realizado
            : totalRealizado - totalOrcado;  // RECEITAS: Realizado - Or√ßado

        // Realizado M√©dia
        const realizadoMedia = numMeses > 0 ? totalRealizado / numMeses : 0;

        // % Realizado M√©dia (percentual sobre RECEITA Realizado M√©dia)
        const percRealizadoMedia = receitaRealizadoMedia > 0
            ? (realizadoMedia / receitaRealizadoMedia) * 100
            : 0;

        // M√©dia Or√ßado (para c√°lculo da m√©dia diferen√ßa)
        const mediaOrcado = numMeses > 0 ? totalOrcado / numMeses : 0;

        // M√©dia Diferen√ßa: inverte c√°lculo para receitas vs despesas
        const mediaDif = isDespesa
            ? mediaOrcado - realizadoMedia  // DESPESAS: M√©dia Or√ßado - Realizado M√©dia
            : realizadoMedia - mediaOrcado;  // RECEITAS: Realizado M√©dia - M√©dia Or√ßado

        // % M√©dia Diferen√ßa (percentual sobre M√©dia Or√ßado)
        const percMediaDif = mediaOrcado > 0
            ? (mediaDif / mediaOrcado) * 100
            : 0;

        bodyHTML += `
            <td class="col-total">${formatMoney(totalOrcado)}</td>
            <td class="col-total">${formatMoney(totalRealizado)}</td>
            <td class="col-total">${formatMoneyCondicional(totalDif)}</td>
            <td class="col-total">${formatMoney(realizadoMedia)}</td>
            <td class="col-total" style="color: #6b7280; font-weight: 500;">${formatPercent(percRealizadoMedia)}</td>
            <td class="col-total">${formatMoneyCondicional(mediaDif)}</td>
            <td class="col-total">${formatPercentCondicional(percMediaDif)}</td>
        `;

        bodyHTML += `</tr>`;
    });

    document.getElementById('table-body').innerHTML = bodyHTML;
}

function renderizarCenarios(data) {
    const { totais_calculados, meses } = data;

    console.log('üîç DEBUG renderizarCenarios:');
    console.log('   totais_calculados:', totais_calculados);
    console.log('   meses:', meses);
    console.log('   fluxo_caixa keys:', Object.keys(totais_calculados.fluxo_caixa || {}));
    console.log('   real keys:', Object.keys(totais_calculados.real || {}));
    console.log('   real_mp keys:', Object.keys(totais_calculados.real_mp || {}));

    // Renderizar cada cen√°rio com cabe√ßalho pr√≥prio
    renderizarCenario('fluxo_caixa', 'fc-header-row', 'fc-body', totais_calculados, meses);
    renderizarCenario('real', 'real-header-row', 'real-body', totais_calculados, meses);
    renderizarCenario('real_mp', 'realmp-header-row', 'realmp-body', totais_calculados, meses);
}

function renderizarCenario(tipo, headerId, bodyId, totais_calculados, meses) {
    const cenario = totais_calculados[tipo] || {};

    console.log(`üîç DEBUG renderizarCenario(${tipo}):`)
    console.log('   cenario:', cenario);
    console.log('   cenario keys:', Object.keys(cenario));

    // Coletar dados da Receita para c√°lculo de percentuais
    const receitaOrcadoPorMes = {};
    const receitaRealizadoPorMes = {};
    meses.forEach(mes => {
        const chave = `${mes.ano}_${mes.mes_numero}`;
        const dados = cenario[chave];
        if (dados) {
            if (dados.orcamento && dados.orcamento.receita !== undefined) {
                receitaOrcadoPorMes[chave] = dados.orcamento.receita;
            }
            if (dados.realizado && dados.realizado.receita !== undefined) {
                receitaRealizadoPorMes[chave] = dados.realizado.receita;
            }
        }
    });

    // Criar cabe√ßalho com 2 linhas
    const headerElement = document.getElementById(headerId);

    // Primeira linha: Categoria + nome dos meses (4 colunas por m√™s) + TOTAL (7 colunas)
    let headerHTML = '<tr><th rowspan="2">Categoria</th>';
    meses.forEach(mes => {
        headerHTML += `<th colspan="4" style="border-bottom: 2px solid white;">${mes.mes_nome} ${mes.ano}</th>`;
    });
    headerHTML += `<th colspan="7" style="border-bottom: 2px solid white; background: #ffd54f; color: #333; border-left: 3px solid #333;">TOTAL</th>`;
    headerHTML += '</tr>';

    // Segunda linha: subcolunas (Or√ßamento, Realizado, %, Diferen√ßa) repetidas para cada m√™s + 7 colunas de totais
    headerHTML += '<tr>';
    meses.forEach(() => {
        headerHTML += `
            <th>Or√ßamento</th>
            <th>Realizado</th>
            <th>% Atingido</th>
            <th>Diferen√ßa</th>
        `;
    });
    // Colunas de TOTAL
    headerHTML += `
        <th style="background: #ffd54f; color: #333;">Total Or√ßado</th>
        <th style="background: #ffd54f; color: #333;">Total Realizado</th>
        <th style="background: #ffd54f; color: #333;">Diferen√ßa</th>
        <th style="background: #ffd54f; color: #333;">Realizado M√©dia</th>
        <th style="background: #ffd54f; color: #333;">% Realizado M√©dia</th>
        <th style="background: #ffd54f; color: #333;">M√©dia Diferen√ßa</th>
        <th style="background: #ffd54f; color: #333;">% M√©dia Diferen√ßa</th>
    `;
    headerHTML += '</tr>';

    headerElement.innerHTML = headerHTML;

    // Criar corpo com 3 linhas (Receita, Despesa, Geral)
    const categorias = ['Receita', 'Despesa', 'Geral'];
    let bodyHTML = '';
    const numMeses = meses.length;

    categorias.forEach(cat => {
        const catKey = cat.toLowerCase();
        bodyHTML += `<tr><td style="font-weight: 600; color: #ff6b35;">${cat}</td>`;

        // Vari√°veis para calcular totais
        let totalOrcamento = 0;
        let totalRealizado = 0;
        let totalDiferenca = 0;

        meses.forEach((mes, idx) => {
            const chave = `${mes.ano}_${mes.mes_numero}`;
            const dados = cenario[chave];

            // Log s√≥ do primeiro m√™s da categoria Receita
            if (idx === 0 && cat === 'Receita') {
                console.log(`      Primeiro m√™s (${mes.mes_nome}): chave=${chave}, dados=`, dados);
            }

            if (dados) {
                const orcamento = dados.orcamento && dados.orcamento[catKey] !== undefined ? dados.orcamento[catKey] : null;
                const realizado = dados.realizado && dados.realizado[catKey] !== undefined ? dados.realizado[catKey] : null;
                const diferenca = dados.diferenca && dados.diferenca[catKey] !== undefined ? dados.diferenca[catKey] : null;

                // Calcular % Atingido: % Realizada - % Or√ßada
                let percAtingido = null;
                const receitaOrcadoMes = receitaOrcadoPorMes[chave] || 0;
                const receitaRealizadoMes = receitaRealizadoPorMes[chave] || 0;

                if (orcamento !== null && realizado !== null) {
                    const percOrcado = receitaOrcadoMes > 0 ? (orcamento / receitaOrcadoMes) * 100 : 0;
                    const percRealizado = receitaRealizadoMes > 0 ? (realizado / receitaRealizadoMes) * 100 : 0;
                    percAtingido = percRealizado - percOrcado;
                }

                // Acumular totais
                if (orcamento !== null) totalOrcamento += orcamento;
                if (realizado !== null) totalRealizado += realizado;
                if (diferenca !== null) totalDiferenca += diferenca;

                bodyHTML += `
                    <td>${orcamento !== null ? formatMoney(orcamento) : '<span class="valor-neutro">-</span>'}</td>
                    <td>${realizado !== null ? formatMoney(realizado) : '<span class="valor-neutro">-</span>'}</td>
                    <td>${percAtingido !== null ? '<span style="font-weight: 600;">' + formatPercent(percAtingido) + '</span>' : '<span class="valor-neutro">-</span>'}</td>
                    <td>${diferenca !== null ? formatMoneyCondicional(diferenca) : '<span class="valor-neutro">-</span>'}</td>
                `;
            } else {
                bodyHTML += `
                    <td><span class="valor-neutro">-</span></td>
                    <td><span class="valor-neutro">-</span></td>
                    <td><span class="valor-neutro">-</span></td>
                    <td><span class="valor-neutro">-</span></td>
                `;
            }
        });

        // Calcular as 7 colunas de totais
        const realizadoMedia = numMeses > 0 ? totalRealizado / numMeses : 0;
        const mediaOrcado = numMeses > 0 ? totalOrcamento / numMeses : 0;

        // Para % Realizado M√©dia, preciso da receita como base
        // Se for a categoria Receita, usa ela mesma; caso contr√°rio busca do total da receita
        let percRealizadoMedia = 0;
        if (cat === 'Receita' && realizadoMedia > 0) {
            percRealizadoMedia = 100; // Receita √© 100% de si mesma
        }

        // M√©dia Diferen√ßa (j√° est√° calculada pela soma das diferen√ßas / num meses)
        const mediaDiferenca = numMeses > 0 ? totalDiferenca / numMeses : 0;

        // % M√©dia Diferen√ßa
        const percMediaDif = mediaOrcado > 0 ? (mediaDiferenca / mediaOrcado) * 100 : 0;

        // Renderizar colunas de totais
        bodyHTML += `
            <td style="background: #fff9e6;">${formatMoney(totalOrcamento)}</td>
            <td style="background: #fff9e6;">${formatMoney(totalRealizado)}</td>
            <td style="background: #fff9e6;">${formatMoneyCondicional(totalDiferenca)}</td>
            <td style="background: #fff9e6;">${formatMoney(realizadoMedia)}</td>
            <td style="background: #fff9e6; color: #6b7280; font-weight: 500;">${cat === 'Receita' ? formatPercent(100) : '<span class="valor-neutro">-</span>'}</td>
            <td style="background: #fff9e6;">${formatMoneyCondicional(mediaDiferenca)}</td>
            <td style="background: #fff9e6;">${formatPercentCondicional(percMediaDif)}</td>
        `;

        bodyHTML += `</tr>`;
    });

    document.getElementById(bodyId).innerHTML = bodyHTML;
}

// Fun√ß√£o para alternar tela cheia
function toggleFullscreen() {
    const container = document.getElementById('table-container');
    const btn = document.getElementById('btn-fullscreen');
    const icon = btn.querySelector('i');

    if (container.classList.contains('fullscreen-mode')) {
        // Sair da tela cheia
        container.classList.remove('fullscreen-mode');
        icon.className = 'bi bi-arrows-fullscreen me-2';
        btn.innerHTML = '<i class="bi bi-arrows-fullscreen me-2"></i>Tela Cheia';
    } else {
        // Entrar em tela cheia
        container.classList.add('fullscreen-mode');
        icon.className = 'bi bi-fullscreen-exit me-2';
        btn.innerHTML = '<i class="bi bi-fullscreen-exit me-2"></i>Sair da Tela Cheia';
    }
}

// Atalho ESC para sair da tela cheia
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const container = document.getElementById('table-container');
        if (container && container.classList.contains('fullscreen-mode')) {
            toggleFullscreen();
        }
    }
});
</script>

{% endblock %}
